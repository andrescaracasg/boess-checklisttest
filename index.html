<html lang="de"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BOESS Checklist ‚Äì  ¬∑  (0%)</title>
  
  <!-- Librer√≠as para generaci√≥n de documentos reales -->
  <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
      :root{
        --brand: #07694D;
        --brand-700: #05563F;
        --brand-600: #07694D;
        --brand-500: #0A7B59;
        --brand-200: #CFE9DF;
        --ink: #111827;
        --muted: #6b7280;
        --bg1: #f5f7fa;
        --bg2: #e8f5f0;
        --card: #ffffff;
        --border: #e6e8f0;
        --shadow: 0 8px 24px rgba(0,0,0,.08);
        --radius: 18px;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Calibri, Arial, sans-serif;

        --ok-color: #10b981;
        --nok-color: #ef4444;
        --na-color: #6b7280;
        --ok-bg: #d1fae5;
        --nok-bg: #fee2e2;
        --na-bg: #f3f4f6;
      }
      *{ box-sizing: border-box; }
      body{
        margin:0;
        color: var(--ink);
        background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
        min-height: 100vh;
        line-height: 1.55;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      body.loaded { opacity: 1; }
      a{ color: var(--brand); text-decoration: none; }
      a:hover{ text-decoration: underline; }
      
      /* Scrollbar personalizado */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--brand-200);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--brand-300);
      }
      
      .container{
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px;
      }
      .shell{ background: transparent; border-radius: var(--radius); }

      /* Header mejorado */
      .topbar{
        background: linear-gradient(135deg, var(--brand-700) 0%, var(--brand-600) 100%);
        border-radius: 22px 22px 18px 18px;
        padding: 32px 32px 24px;
        box-shadow: 0 10px 30px rgba(7, 105, 77, 0.25);
        border: none;
        color: white;
      }
      .brandRow{
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
      }
      .logo{
        display:flex;
        align-items:center;
        gap: 14px;
        min-width: 240px;
      }
      .logoIcon{
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.9);
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        color: var(--brand-600);
        font-weight: 900;
        letter-spacing: 1px;
        font-size: 24px;
        transition: transform 0.3s ease;
      }
      .logoIcon:hover {
        transform: scale(1.05);
      }
      .logoText{
        font-size: 24px;
        font-weight: 900;
        color: white;
        line-height: 1.1;
        letter-spacing: 0.5px;
      }
      .logoSub{
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        margin-top: 6px;
      }
      .chipRow{
        display:flex; gap: 10px; align-items:center; flex-wrap: wrap;
      }
      .pill{
        font-size: 12px;
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .titleBlock{ margin-top: 20px; }
      h1{
        margin: 0 0 12px 0;
        font-size: 32px;
        line-height: 1.15;
        color: white;
        letter-spacing: .2px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .subtitle{
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        max-width: 860px;
        line-height: 1.5;
      }

      main{
        display:grid;
        grid-template-columns: 1fr 380px;
        gap: 22px;
        margin-top: 18px;
        margin-bottom: 18px;
      }
      @media (max-width: 980px){
        main{ grid-template-columns: 1fr; }
        .sticky{ position: static !important; }
      }
      
      /* Cards mejoradas */
      .card{
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 
          0 10px 30px rgba(0, 0, 0, 0.08),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 
          0 15px 40px rgba(0, 0, 0, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
        transform: translateY(-2px);
      }
      .sticky{ position: sticky; top: 14px; }

      /* Inputs mejorados */
      input[type="text"], textarea, select{
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        outline: none;
        font-size: 15px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      }
      textarea{ min-height: 42px; resize: vertical; }
      input:focus, textarea:focus, select:focus{
        border-color: var(--brand-500);
        box-shadow: 
          0 0 0 4px rgba(7, 105, 77, 0.1),
          0 4px 12px rgba(0, 0, 0, 0.05);
        background: white;
      }
      
      /* Botones mejorados */
      button{
        padding: 14px 20px;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 800;
        font-size: 14px;
        white-space: nowrap;
        transition: all 0.3s ease;
        letter-spacing: 0.3px;
        position: relative;
        overflow: hidden;
      }
      button:active{ transform: translateY(1px); }
      
      /* Efecto ripple para botones */
      button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
      }
      button:focus:not(:active)::after {
        animation: ripple 1s ease-out;
      }
      @keyframes ripple {
        0% {
          transform: scale(0, 0);
          opacity: 0.5;
        }
        100% {
          transform: scale(20, 20);
          opacity: 0;
        }
      }
      
      .btn-primary{
        background: linear-gradient(135deg, var(--brand-600), var(--brand-500));
        color:#fff;
        box-shadow: 0 4px 12px rgba(7, 105, 77, 0.25);
      }
      .btn-primary:hover{
        background: linear-gradient(135deg, var(--brand-700), var(--brand-600));
        box-shadow: 0 6px 20px rgba(7, 105, 77, 0.35);
        transform: translateY(-2px);
      }
      .btn-ghost{ background: transparent; color: var(--brand-600); }
      .btn-ghost:hover{ background: rgba(7,105,77,.06); }
      .btn-danger{
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color:#fff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
      }
      .btn-danger:hover{
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
        transform: translateY(-2px);
      }
      .btn-soft{
        background: linear-gradient(135deg, var(--brand-200), #bfe3d6);
        color: var(--brand-700);
        box-shadow: 0 2px 8px rgba(7, 105, 77, 0.15);
      }
      .btn-soft:hover{
        background: linear-gradient(135deg, #bfe3d6, #a8d9c7);
        box-shadow: 0 4px 12px rgba(7, 105, 77, 0.25);
        transform: translateY(-2px);
      }
      .btn-outline{
        background: rgba(255, 255, 255, 0.9);
        color: var(--ink);
        border: 2px solid #d7dbe7;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      }
      .btn-outline:hover{
        background: #f6f7fb;
        border-color: var(--brand-300);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }
      .muted{ color: var(--muted); font-size: 13px; }
      .kbd{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        background:#f3f4f6;
        padding:2px 6px;
        border-radius:8px;
        border: 1px solid #e5e7eb;
      }
      .row{ display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
      .row > *{ flex: 1; min-width: 220px; }
      .row-tight{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
      .row-tight > *{ flex: 0 0 auto; }
      @media (max-width: 520px){
        .container{ padding: 16px; }
        .topbar{ padding: 24px 20px 20px; border-radius: 18px 18px 16px 16px; }
        main{ gap: 14px; }
        .card { padding: 18px; }
        .row { flex-direction: column; }
        .row > * { min-width: 100%; }
      }
      @media (max-width: 480px) {
        .logo {
          flex-direction: column;
          text-align: center;
          gap: 12px;
        }
        .modeCard label {
          min-width: 100%;
        }
        .sub-check {
          flex-direction: column;
          gap: 8px;
        }
      }

      .hero{
        border: 2px solid rgba(229, 231, 235, 0.8);
        border-radius: 16px;
        padding: 16px;
        background: rgba(251, 252, 255, 0.8);
        backdrop-filter: blur(5px);
      }
      .setupTitle{
        display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .setupTitle h2{ margin: 0; font-size: 18px; color: var(--ink); font-weight: 700; }
      
      /* Barra de progreso mejorada */
      .progressBar{
        height: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        overflow: hidden;
        border: none;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .progressBar > div{
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #10b981, #34d399);
        border-radius: 999px;
        transition: width .3s ease;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
      }

      .modeCard{
        display:flex;
        gap: 10px;
        align-items:center;
        flex-wrap: wrap;
        padding: 16px;
        border: 2px solid rgba(229, 231, 235, 0.8);
        border-radius: 16px;
        background: rgba(251, 252, 255, 0.8);
        backdrop-filter: blur(5px);
      }
      .modeCard label{
        display:flex; align-items:center; gap: 10px;
        padding: 12px 16px;
        border-radius: 14px;
        border: 2px solid #e6e8f0;
        cursor: pointer;
        background: #fff;
        flex: 1;
        min-width: 260px;
        font-weight: 700;
        color: #374151;
        transition: all 0.2s ease;
      }
      .modeCard label:hover {
        border-color: var(--brand-300);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }
      .modeCard input[type="radio"]{ accent-color: var(--brand-600); transform: translateY(1px); }

      .groups { display: grid; gap: 12px; margin-top: 14px; }
      
      /* Grupos mejorados */
      .group{
        border: 1px solid rgba(229, 231, 235, 0.8);
        border-radius: 16px;
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
        margin-bottom: 12px;
      }
      .group:hover {
        border-color: var(--brand-200);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }
      .groupHeader{
        display:flex;
        justify-content:space-between;
        gap: 10px;
        padding: 16px 20px;
        align-items:center;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #eef0f7;
        flex-wrap: wrap;
      }
      .groupTitleRow{ display:flex; gap: 10px; align-items:center; flex: 1; min-width: 240px; }
      .groupTitle{
        font-weight: 900;
        font-size: 14px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 2px solid #e6e8f0;
        flex: 1;
        min-width: 180px;
        outline: none;
        background: #fff;
        transition: all 0.2s ease;
      }
      .groupTitle:focus{
        border-color: #bfe3d6;
        box-shadow: 0 0 0 4px rgba(7,105,77,.12);
      }
      .progress{ font-size: 12px; color: var(--muted); font-weight: 900; }
      .groupBody{ padding: 16px; display: grid; gap: 12px; }
      ul.items{ list-style:none; padding: 0; margin: 0; display:grid; gap: 12px; }
      li.item{
        display:flex;
        flex-direction: column;
        gap: 10px;
        padding: 16px;
        border: 2px solid rgba(229, 231, 235, 0.8);
        border-radius: 14px;
        background: #fff;
        transition: all 0.3s ease;
      }
      li.item:hover{
        border-color: var(--brand-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transform: translateY(-1px);
      }
      .itemTop{ display:flex; align-items:center; gap: 12px; }
      .itemTop input[type="checkbox"]{ accent-color: var(--brand-600); }
      .itemTitle{
        flex:1;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        font-weight: 800;
      }
      .done .itemTitle{ text-decoration: line-through; color: var(--muted); }
      .noteLabel{ font-size: 12px; color: var(--muted); margin-bottom: 8px; font-weight: 900; }
      .noteBox textarea{ width: 100%; font-size: 13px; padding: 12px; border-radius: 12px; min-height: 60px; }

      .sub-check-container {
        margin: 10px 0;
        padding: 12px;
        border: 2px solid rgba(230,232,240, 0.8);
        border-radius: 14px;
        background: rgba(251, 252, 255, 0.8);
        backdrop-filter: blur(5px);
      }

      .sub-check {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        padding: 8px;
      }

      .sub-check .label {
        font-size: 13px;
        font-weight: 700;
        color: var(--ink);
        min-width: 100px;
      }

      .sub-check .option {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: 700;
        border: 2px solid transparent;
        min-width: 100px;
        text-align: center;
        justify-content: center;
      }
      .sub-check .option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .sub-check .option.ok {
        color: var(--ok-color);
        background: var(--ok-bg);
      }

      .sub-check .option.ok:hover,
      .sub-check .option.ok.selected {
        background: var(--ok-color);
        color: white;
        border-color: var(--ok-color);
      }

      .sub-check .option.nok {
        color: var(--nok-color);
        background: var(--nok-bg);
      }

      .sub-check .option.nok:hover,
      .sub-check .option.nok.selected {
        background: var(--nok-color);
        color: white;
        border-color: var(--nok-color);
      }

      .sub-check .option.na {
        color: var(--na-color);
        background: var(--na-bg);
      }

      .sub-check .option.na:hover,
      .sub-check .option.na.selected {
        background: var(--na-color);
        color: white;
        border-color: var(--na-color);
      }

      .sub-check input[type="radio"] {
        display: none;
      }

      /* Badge de estado mejorado */
      .sub-check-status {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: 800;
        margin-left: auto;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .status-ok { background: var(--ok-bg); color: var(--ok-color); }
      .status-nok { background: var(--nok-bg); color: var(--nok-color); }
      .status-na { background: var(--na-bg); color: var(--na-color); }
      .status-pending { background: #f3f4f6; color: #6b7280; }

      .sideTitle{ margin: 0 0 12px; font-size: 18px; color: var(--brand); font-weight: 700; }
      
      /* Stats box con gradiente */
      .statBox{
        background: linear-gradient(135deg, var(--brand-200) 0%, #d1fae5 100%);
        border: 1px solid rgba(7,105,77,.15);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .statRow{ display:flex; justify-content:space-between; gap: 12px; align-items:center; flex-wrap: wrap; }
      .bigStat{
        font-size: 32px;
        font-weight: 1000;
        background: linear-gradient(135deg, var(--brand-700), #0a7b59);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .smallStat{ font-size: 12px; color: #1f2937; font-weight: 900; }
      .actionsGrid{
        display:grid;
        gap: 10px;
        margin-top: 12px;
      }
      .actionsGrid button{ width: 100%; }

      .menu{ position: relative; width: 100%; }
      .menuPanel{
        position: absolute;
        left: 0;
        top: 46px;
        width: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        box-shadow: 0 12px 32px rgba(0,0,0,.15);
        padding: 8px;
        display: none;
        z-index: 10;
        animation: fadeIn 0.2s ease-out;
      }
      .menuPanel.open{ display:block; }
      .menuPanel button{
        width: 100%;
        text-align: left;
        border-radius: 12px;
        background: transparent;
        color: var(--ink);
        padding: 12px 14px;
        font-weight: 900;
        transition: all 0.2s ease;
      }
      .menuPanel button:hover{
        background: rgba(243, 244, 246, 0.8);
        transform: translateX(4px);
      }
      .menuPanel hr{ border:0; border-top:1px solid rgba(238, 240, 247, 0.8); margin: 8px 6px; }

      /* Modales mejorados */
      .modalBackdrop{
        position: fixed; inset: 0;
        background: rgba(17,24,39,.65);
        backdrop-filter: blur(4px);
        display:none;
        align-items:center; justify-content:center;
        padding: 18px;
        z-index: 100;
        animation: fadeIn 0.3s ease;
      }
      .modalBackdrop.open{ display:flex; }
      .modal{
        width: min(760px, 100%);
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 
          0 25px 50px rgba(0, 0, 0, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
        overflow: hidden;
        animation: fadeIn 0.3s ease;
      }
      .modalHeader{
        display:flex; align-items:center; justify-content:space-between; gap: 10px;
        padding: 20px 24px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid rgba(238, 240, 247, 0.8);
      }
      .modalHeader h3{ margin: 0; font-size: 16px; color: var(--ink); font-weight: 700; }
      .modalBody{ padding: 20px 24px; }
      
      /* Footer mejorado */
      footer{
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 0 0 20px 20px;
        padding: 20px 24px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(230,232,240,.9);
        text-align: center;
        color: var(--muted);
        font-size: 13px;
        border-top: 1px solid #eef0f7;
      }
      footer a {
        color: var(--brand-600);
        font-weight: 600;
        text-decoration: none;
        transition: color 0.2s ease;
      }
      footer a:hover {
        color: var(--brand-700);
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .sub-check {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .sub-check .label {
          min-width: auto;
          width: 100%;
        }
        .sub-check .option {
          width: 100%;
          justify-content: center;
        }
      }

      /* Estilos para el mensaje de carga */
      .loading {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* ====== ESTILOS PARA EL ICONO DE INFORMACI√ìN ====== */
      .info-icon {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--brand-500), var(--brand-600));
          color: white;
          font-size: 12px;
          font-weight: 900;
          cursor: help;
          margin-left: 8px;
          transition: all 0.3s ease;
          flex-shrink: 0;
          box-shadow: 0 2px 6px rgba(7, 105, 77, 0.25);
      }
      .info-icon:hover {
          background: linear-gradient(135deg, var(--brand-600), var(--brand-700));
          color: white;
          transform: scale(1.1) rotate(5deg);
          box-shadow: 0 4px 12px rgba(7, 105, 77, 0.35);
      }

      /* Modal para informaci√≥n de sub-check */
      .subcheck-info-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(4px);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          padding: 20px;
          animation: fadeIn 0.3s ease;
      }
      .subcheck-info-modal.open {
          display: flex;
      }
      .subcheck-info-content {
          background: rgba(255, 255, 255, 0.98);
          backdrop-filter: blur(20px);
          border-radius: 20px;
          padding: 28px;
          max-width: 600px;
          width: 100%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 
              0 20px 60px rgba(0, 0, 0, 0.3),
              inset 0 1px 0 rgba(255, 255, 255, 0.6);
          border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .subcheck-info-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 24px;
          padding-bottom: 20px;
          border-bottom: 2px solid var(--brand-200);
      }
      .subcheck-info-header h3 {
          margin: 0;
          font-size: 18px;
          color: var(--brand);
          flex: 1;
          padding-right: 20px;
          font-weight: 700;
      }
      .close-info-btn {
          background: transparent;
          border: none;
          font-size: 24px;
          color: var(--muted);
          cursor: pointer;
          padding: 0;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 8px;
          transition: all 0.2s ease;
      }
      .close-info-btn:hover {
          background: rgba(243, 244, 246, 0.8);
          color: var(--brand);
      }
      .subcheck-info-body {
          font-size: 14px;
          line-height: 1.6;
          color: var(--ink);
      }
      .subcheck-info-question {
          background: linear-gradient(135deg, var(--brand-200), #d1fae5);
          padding: 16px 20px;
          border-radius: 12px;
          margin-bottom: 20px;
          border-left: 4px solid var(--brand);
          font-weight: 600;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }
      .subcheck-info-notes {
          background: linear-gradient(135deg, #f9fafb, #f3f4f6);
          padding: 16px 20px;
          border-radius: 12px;
          border: 1px solid rgba(229, 231, 235, 0.8);
          font-size: 13px;
          color: var(--muted);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .subcheck-info-notes ul {
          margin: 12px 0;
          padding-left: 20px;
      }
      .subcheck-info-notes li {
          margin-bottom: 8px;
          line-height: 1.5;
      }

      /* Ajustes para el t√≠tulo del sub-check con icono */
      .itemTitle {
          display: flex;
          align-items: center;
          flex: 1;
          min-width: 0;
      }
      .itemTitle-text {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          flex: 1;
      }

      /* Animaciones */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card, .group {
        animation: fadeIn 0.4s ease-out;
      }

      /* Efecto de pulsaci√≥n */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(7, 105, 77, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(7, 105, 77, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(7, 105, 77, 0);
        }
      }
      .highlight {
        animation: pulse 2s infinite;
      }

      /* Estilos responsive para el modal */
      @media (max-width: 640px) {
          .subcheck-info-modal {
              padding: 10px;
          }
          .subcheck-info-content {
              padding: 20px;
              max-height: 85vh;
          }
          .subcheck-info-header h3 {
              font-size: 16px;
          }
      }
      
      /* Indicador de guardado */
      #saveIndicator {
        display: none;
        background: linear-gradient(135deg, #10b981, #34d399);
        color: white;
        border: none;
        animation: pulse 1s ease;
      }
      
      /* ====== ESTILOS PARA COMPATIBILIDAD ====== */
      #compatBtn {
          background: linear-gradient(135deg, #f59e0b, #d97706);
          color: white;
          border: none;
          padding: 8px 14px;
          border-radius: 10px;
          font-weight: 700;
          font-size: 13px;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-left: 8px;
      }
      
      #compatBtn:hover {
          background: linear-gradient(135deg, #d97706, #b45309);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
      }
      
      .compat-option {
          padding: 12px;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          margin-bottom: 12px;
          background: #f9fafb;
          transition: all 0.3s ease;
      }
      
      .compat-option:hover {
          border-color: var(--brand-200);
          background: #f3f4f6;
      }
      
      .compat-option strong {
          color: var(--brand-700);
          display: block;
          margin-bottom: 6px;
          font-size: 14px;
      }
      
      .compat-option .muted {
          font-size: 12px;
          line-height: 1.5;
      }
      
      .status-indicator {
          display: inline-block;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          margin-right: 6px;
          vertical-align: middle;
      }
      
      .status-ok { background: #10b981; }
      .status-warning { background: #f59e0b; }
      .status-error { background: #ef4444; }
      
      .compat-alert {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: white;
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.15);
          border-left: 4px solid #f59e0b;
          max-width: 300px;
          z-index: 1000;
          animation: slideInUp 0.3s ease;
          display: none;
      }
      
      @keyframes slideInUp {
          from {
              transform: translateY(100px);
              opacity: 0;
          }
          to {
              transform: translateY(0);
              opacity: 1;
          }
      }
      
      .compat-alert h4 {
          margin: 0 0 8px 0;
          color: #92400e;
          font-size: 14px;
      }
      
      .compat-alert p {
          margin: 0 0 12px 0;
          font-size: 12px;
          color: #6b7280;
          line-height: 1.4;
      }
      
      .compat-alert button {
          padding: 6px 12px;
          font-size: 12px;
          width: auto;
          margin-right: 8px;
      }
      
      /* Estilos para mensajes de error de exportaci√≥n */
      .export-warning {
          background: #fffbeb;
          border: 1px solid #fde68a;
          border-radius: 8px;
          padding: 12px;
          margin: 10px 0;
          font-size: 12px;
      }
      
      .export-warning strong {
          color: #92400e;
          display: block;
          margin-bottom: 4px;
      }
  </style>
<!-- 
  BOESS Checklist System - Portable Version
  =========================================
  
  ANLEITUNG F√úR OPTIMALE NUTZUNG:
  1. MIT SERVER (Empfohlen):
     - Terminal/CMD √∂ffnen in diesem Ordner
     - Befehl eingeben: python -m http.server 8000
     - Browser √∂ffnen: http://localhost:8000
  
  2. OHNE SERVER (Eingeschr√§nkt):
     - Direkt index.html im Browser √∂ffnen
     - PDF und CSV Export funktionieren
     - Word/Excel ben√∂tigen Internet
     - Speicherung kann eingeschr√§nkt sein
  
  HINWEIS: F√ºr beste Ergebnisse immer lokalen Server verwenden!
  -->
<!-- 
  BOESS Checklist System - Portable Version
  =========================================
  
  ANLEITUNG F√úR OPTIMALE NUTZUNG:
  1. MIT SERVER (Empfohlen):
     - Terminal/CMD √∂ffnen in diesem Ordner
     - Befehl eingeben: python -m http.server 8000
     - Browser √∂ffnen: http://localhost:8000
  
  2. OHNE SERVER (Eingeschr√§nkt):
     - Direkt index.html im Browser √∂ffnen
     - PDF und CSV Export funktionieren
     - Word/Excel ben√∂tigen Internet
     - Speicherung kann eingeschr√§nkt sein
  
  HINWEIS: F√ºr beste Ergebnisse immer lokalen Server verwenden!
  -->
</head>
<body class="loaded" style="overflow: hidden;">
  <div class="container">
      <div class="shell">
          <header class="topbar">
              <div class="brandRow">
                  <div class="logo">
                      <div class="logoIcon">&amp;</div>
                      <div>
                          <div class="logoText">BOESS Checklist LCM</div>
                          <div class="logoSub">Live Cycle Management f√ºr Tunnel-Funksysteme ¬∑ Offline-f√§hig</div>
                      </div>
                  </div>

                  <div class="chipRow">
                      <span class="pill" id="counter">0/0 (0% ‚úì)</span>
                      <span class="pill highlight" id="saveIndicator" style="display: none;">
                        ‚úì Gespeichert
                      </span>
                      <button class="btn-outline" id="helpBtn" type="button">Hilfe</button>
                      <button class="btn-outline" id="compatBtn" type="button">‚ö° Optimieren</button>
                  </div>
              </div>

              <div class="titleBlock">
                  <h1>Checklist Boess <span style="font-size: 20px; font-weight: 800; color:rgba(255,255,255,0.9);">(Live Cycle Management: LCI/LCE)</span></h1>
                  <p class="subtitle">W√§hle zuerst <b>Teilanlage</b> y <b>Tunnel</b>, entscheide den <b>Inspektionsmodus</b>, dokumentiere Pr√ºfpunkte/Sub-Checks und exportiere das Ergebnis als PDF/CSV/Word/Excel.</p>
              </div>
          </header>

          <main>
              <section class="card" aria-label="Checklist App">
                  <div id="setupCard">
                      <div class="setupTitle">
                          <h2>1) Teilanlage &amp; Tunnel w√§hlen</h2>
                          <span class="pill" id="metaChip">GE?? ¬∑ Tunnel</span>
                      </div>
                      <div class="progressBar" aria-hidden="true"><div id="setupProgress" style="width: 0%;"></div></div>

                      <div class="hero" style="margin-top: 12px;">
                          <div class="row">
                              <select id="anlageSelect" aria-label="Teilanlage ausw√§hlen">
                                  <option value="">Teilanlage ausw√§hlen‚Ä¶</option>
                                  <option value="GE08">GE08</option>
                                  <option value="GE10">GE10</option>
                                  <option value="GE11">GE11</option>
                              </select>

                              <select id="tunnelSelect" disabled="" aria-label="Tunnel ausw√§hlen"><option value="">Tunnel ausw√§hlen‚Ä¶</option></select>

                              <button class="btn-primary" id="startBtn" disabled="" type="button">Start</button>
                          </div>
                          <div class="muted" id="setupHint" style="margin-top:10px;">Bitte zuerst Teilanlage ausw√§hlen.</div>
                      </div>

                      <div class="muted" style="margin-top:12px;">
                          Tipp: Wenn keine Tunnel-Liste hinterlegt ist, kannst du den Tunnel <b>manuell</b> eingeben.
                      </div>
                  </div>

                  <div id="appCard" style="display:none;">
                      <div class="row">
                          <input id="listName" type="text" placeholder="Listenname (LCI/ LCE - z.B. Tunnel XY )">
                          <button class="btn-soft" id="loadTemplateBtn" type="button" title="Vorlage mit Funksysteme-Pr√ºfpunkten laden">Vorlage laden</button>
                      </div>

                      <div class="modeCard" style="margin-top:12px;">
                          <div class="muted" style="min-width:160px; font-weight:1000; color:#374151;">2) Inspektion:</div>
                          <label><input type="radio" name="mode" value="basic" id="basicMode"> Basisinspektion (visuell, ohne Messungen)</label>
                          <label><input type="radio" name="mode" value="detailed" id="detailedMode"> Detailinspektion (visuell, mit Messungen, Vergleich mit Dokumenten/Revisionen)</label>
                      </div>

                      <div class="row" style="margin-top: 12px;">
                          <input id="newGroupTitle" type="text" placeholder="3) Neuer Pr√ºfpunkt (z.B. UKW)">
                          <button class="btn-primary" id="addGroupBtn" type="button">Pr√ºfpunkt hinzuf√ºgen</button>
                      </div>

                      <div class="groups" id="groups"></div>

                      <div class="muted" style="margin-top:12px;">
                          <div>‚ÑπÔ∏è <b>Hinweis:</b> Im <b>Basisinspektion</b>-Modus werden Messpunkte automatisch auf <span style="color:var(--na-color); font-weight:800;">N/A</span> gesetzt.</div>
                          <div style="margin-top:4px;">Tipp: W√§hle f√ºr jeden Sub-Check <span style="color:var(--ok-color);">OK</span>, <span style="color:var(--nok-color);">Nicht OK</span> o<span style="color:var(--na-color);">N/A</span>.</div>
                      </div>
                  </div>
              </section>

              <aside class="card sticky" aria-label="Aktionen">
                  <h2 class="sideTitle">Schnellaktionen</h2>

                  <div class="statBox">
                      <div class="statRow">
                          <div>
                              <div class="smallStat">Fortschritt</div>
                              <div class="bigStat" id="progressBig">0%</div>
                          </div>
                          <div style="flex:1; min-width: 160px;">
                              <div class="smallStat">Status√ºbersicht</div>
                              <div class="muted" id="statusSummary" style="font-weight:900; font-size:11px;">‚úì:0 ‚úó:0 ‚Äì:0</div>
                          </div>
                      </div>
                  </div>

                  <div class="actionsGrid">
                      <div class="menu" id="exportMenu">
                          <button class="btn-outline" id="exportBtn" type="button">Export ‚ñæ</button>
                          <div class="menuPanel" id="exportPanel" role="menu" aria-label="Export">
                              <button id="exportPdfBtn" role="menuitem" type="button">Als PDF exportieren</button>
                              <button id="exportCsvBtn" role="menuitem" type="button">Als CSV exportieren</button>
                              <button id="exportWordBtn" role="menuitem" type="button">Als Word (.docx) exportieren</button>
                              <button id="exportExcelBtn" role="menuitem" type="button">Als Excel (.xlsx) exportieren</button>
                              <hr>
                              <button id="exportJsonBtn" role="menuitem" type="button">Backup exportieren (JSON)</button>
                              <button id="importJsonBtn" role="menuitem" type="button">Backup importieren (JSON)</button>
                          </div>
                      </div>

                      <button class="btn-ghost" id="collapseAllBtn" type="button">Alle einklappen</button>
                      <button class="btn-ghost" id="expandAllBtn" type="button">Alle ausklappen</button>
                      <button class="btn-soft" id="setAllOkBtn" type="button" title="Alle Sub-Checks auf OK setzen">Alle auf OK</button>
                      <button class="btn-danger" id="resetBtn" type="button">Alles l√∂schen</button>
                  </div>

                  <div class="muted" style="margin-top: 12px;">
                      <div id="status" style="font-weight:900;">Wird automatisch im Browser gespeichert.</div>
                      <small>Legende: <span style="color:var(--ok-color);">‚úì OK</span> ¬∑ <span style="color:var(--nok-color);">‚úó Nicht OK</span> ¬∑ <span style="color:var(--na-color);">‚Äì N/A</span></small>
                  </div>
              </aside>
          </main>

          <footer>
            <div><b>Boess Checklist System</b> ¬∑ Corporate Design <span style="color:var(--brand); font-weight:900;"></span> ¬∑ Standalone </div>
          
            <div style="margin-top: 6px; font-size: 12px;">
              ¬© 2026 ¬∑ Copyright
              <a href="https://www.boess.ch" target="_blank" rel="noopener noreferrer">Boess Engineering AG</a>
              ¬∑ T +41 31 330 10 50 - info@boess.ch
            </div>
          </footer>
          
      </div>
  </div>

  <!-- Modal para informaci√≥n de sub-check -->
  <div class="subcheck-info-modal" id="subcheckInfoModal">
      <div class="subcheck-info-content">
          <div class="subcheck-info-header">
              <h3 id="subcheckInfoTitle"></h3>
              <button class="close-info-btn" id="closeSubcheckInfoBtn" type="button">√ó</button>
          </div>
          <div class="subcheck-info-body" id="subcheckInfoBody"></div>
      </div>
  </div>

  <!-- Modal de compatibilidad -->
  <div class="modalBackdrop" id="compatModal" role="dialog" aria-modal="true" aria-label="Optimale Nutzung" style="display: flex;">
      <div class="modal" style="max-width: 900px;">
          <div class="modalHeader">
              <h3>‚ö†Ô∏è Optimale Nutzung der Checklist</h3>
              <button class="btn-ghost" id="closeCompatBtn" type="button">Schlie√üen</button>
          </div>
          <div class="modalBody" style="max-height: 70vh; overflow-y: auto;">
              <h4 style="color:var(--brand); margin-top:0;">F√ºr beste Funktionalit√§t:</h4>
              
              <div class="compat-option">
                  <strong><span class="status-indicator status-ok"></span>1. Lokaler Webserver (Empfohlen)</strong>
                  <div class="muted">
                      <code>python -m http.server 8000</code><br>
                      Dann √∂ffnen: <code>http://localhost:8000</code>
                      <div style="margin-top: 8px;">
                          <strong>Vorteile:</strong><br>
                          ‚Ä¢ Alle Export-Formate verf√ºgbar<br>
                          ‚Ä¢ Lokale Speicherung funktioniert<br>
                          ‚Ä¢ Keine Internetverbindung n√∂tig
                      </div>
                  </div>
              </div>
              
              <div class="compat-option" style="margin-top:12px;">
                  <strong><span class="status-indicator status-ok"></span>2. Mit Internetverbindung</strong>
                  <div class="muted">
                      ‚Ä¢ Word/Excel-Export funktioniert<br>
                      ‚Ä¢ Automatisches Speichern funktioniert<br>
                      ‚Ä¢ Alle Bibliotheken verf√ºgbar
                  </div>
              </div>
              
              <div class="compat-option" style="margin-top:12px;">
                  <strong><span class="status-indicator status-warning"></span>3. Offline von Datei (file://)</strong>
                  <div class="muted">
                      ‚Ä¢ PDF/CSV Export funktioniert<br>
                      ‚Ä¢ Word/Excel Export ben√∂tigt Internet<br>
                      ‚Ä¢ Speicherung kann eingeschr√§nkt sein<br>
                      ‚Ä¢ Manche Browser blockieren localStorage
                  </div>
              </div>
              
              <div style="margin-top:16px; padding:12px; background:#f0f9ff; border-radius:12px; border-left:4px solid var(--brand);">
                  <strong>üí° Tipp f√ºr Weitergabe:</strong><br>
                  Das ganze Verzeichnis als ZIP archivieren und weitergeben.<br>
                  <small>Empf√§nger startet mit <code>python -m http.server 8000</code> f√ºr volle Funktionalit√§t.</small>
              </div>
              
              <div style="margin-top:16px;">
                  <button class="btn-primary" id="downloadPortableBtn" style="width:100%; padding: 12px;">
                      üì¶ Portable Version herunterladen
                  </button>
                  <div class="muted" style="margin-top:8px; font-size:12px; text-align: center;">
                      Enth√§lt diese Datei als eigenst√§ndige HTML f√ºr einfache Weitergabe
                  </div>
              </div>
              
              <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 16px;">
                  <h4 style="color:var(--brand); margin-bottom: 8px;">Aktueller Status:</h4>
                  <div id="compatStatus" style="font-size: 13px;">
                      <div id="fileProtocolStatus" style="margin-bottom: 6px;"><span class="status-indicator status-warning"></span> L√§uft von Datei (file://) - Eingeschr√§nkte Funktionalit√§t</div>
                      <div id="docxStatus" style="margin-bottom: 6px;"><span class="status-indicator status-ok"></span> Word-Export: Verf√ºgbar</div>
                      <div id="xlsxStatus" style="margin-bottom: 6px;"><span class="status-indicator status-ok"></span> Excel-Export: Verf√ºgbar</div>
                      <div id="localStorageStatus"><span class="status-indicator status-ok"></span> Lokale Speicherung: Aktiv</div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Alert flotante para problemas de compatibilidad -->
  <div class="compat-alert" id="compatAlert" style="display: none;">
      <h4><span class="status-indicator status-warning"></span> Begrenzte Funktionalit√§t</h4>
      <p id="alertMessage">Die App l√§uft mit eingeschr√§nkter Funktionalit√§t. Klicken Sie auf 'L√∂sung' f√ºr Details.</p>
      <div style="display: flex; justify-content: flex-end;">
          <button class="btn-ghost" id="closeAlertBtn" type="button" style="font-size: 11px;">Ignorieren</button>
          <button class="btn-primary" id="showCompatBtn" type="button" style="font-size: 11px;">L√∂sung</button>
      </div>
  </div>

  <!-- Modal de ayuda -->
  <div class="modalBackdrop" id="helpModal" role="dialog" aria-modal="true" aria-label="Hilfe" style="display: none;">
      <div class="modal">
          <div class="modalHeader">
              <h3>Hilfe &amp; Kurz-Anleitung</h3>
              <button class="btn-ghost" id="closeHelpBtn" type="button">Schlie√üen</button>
          </div>
          <div class="modalBody">
              <h4 style="color:var(--brand); margin:14px 0 8px;">Schnellstart</h4>
              <ul style="margin:8px 0 0 18px;">
                  <li>Teilanlage &amp; Tunnel ausw√§hlen ‚Üí <b>Start</b></li>
                  <li>Optional: <b>Vorlage laden</b> (LCM - )</li>
                  <li>Pr√ºfpunkt hinzuf√ºgen ‚Üí Sub-Checks hinzuf√ºgen ‚Üí Status w√§hlen</li>
                  <li>Export √ºber <b>Export ‚ñæ</b></li>
              </ul>

              <h4 style="color:var(--brand); margin:14px 0 8px;">Inspektionsmodi</h4>
              <ul style="margin:8px 0 0 18px;">
                  <li><b>Basisinspektion:</b> Visuelle Pr√ºfung ohne Messungen. Messpunkte werden automatisch auf N/A gesetzt.</li>
                  <li><b>Detailinspektion:</b> Vollst√§ndige Pr√ºfung mit Messungen und Dokumentenvergleich.</li>
              </ul>

              <h4 style="color:var(--brand); margin:14px 0 8px;">Sub-Check Status</h4>
              <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
                  <div class="option ok selected" style="pointer-events: none;">OK</div>
                  <div class="option nok selected" style="pointer-events: none;">Nicht OK</div>
                  <div class="option na selected" style="pointer-events: none;">N/A</div>
              </div>
              <ul style="margin:8px 0 0 18px;">
                  <li><b style="color:var(--ok-color);">OK</b>: Pr√ºfpunkt erf√ºllt alle Anforderungen</li>
                  <li><b style="color:var(--nok-color);">Nicht OK</b>: Pr√ºfpunkt nicht erf√ºllt, Aktion erforderlich</li>
                  <li><b style="color:var(--na-color);">N/A</b>: Nicht anwendbar (nicht relevant f√ºr diese Inspektion)</li>
              </ul>

              <h4 style="color:var(--brand); margin:14px 0 8px;">Export-Formate</h4>
              <ul style="margin:8px 0 0 18px;">
                  <li><b>PDF:</b> F√ºr Druck und offizielle Dokumentation</li>
                  <li><b>CSV:</b> F√ºr Datenanalyse und Import in andere Systeme</li>
                  <li><b>Word (.docx):</b> Echt Word-Dokument mit professionellem Layout</li>
                  <li><b>Excel (.xlsx):</b> Echte Excel-Datei mit Tabellen und Formaten</li>
                  <li><b>JSON Backup:</b> F√ºr Sicherung und √úbertragung der datos</li>
              </ul>

              <h4 style="color:var(--brand); margin:14px 0 8px;">Tipps</h4>
              <ul style="margin:8px 0 0 18px;">
                  <li>Klicke auf einen Status, um ihn auszuw√§hlen</li>
                  <li>Backup: Exportiere/Importiere JSON f√ºr Transfer zwischen Ger√§ten/Browsern</li>
                  <li>Speicherung: Pro <b>Teilanlage+Tunnel</b> wird automatisch getrennt gespeichert</li>
                  <li>Word/Excel-Export erfordert Internet f√ºr die Bibliotheken</li>
              </ul>

              <h4 style="color:var(--brand); margin:14px 0 8px;">Datenschutz</h4>
              
              <button class="btn-outline" style="margin-top: 10px; width: 100%;" onclick="showDatenschutzModal()">
                  üìÑ Datenschutzerkl√§rung anzeigen
              </button>
              <div class="muted">
                Keine Daten werden an Server √ºbertragen. Alles bleibt lokal im Browser.
            </div>
          </div>
      </div>
  </div>

  <!-- Modal para Datenschutz -->
  <div class="modalBackdrop" id="datenschutzModal" role="dialog" aria-modal="true" aria-label="Datenschutzerkl√§rung" style="display: none;">
      <div class="modal" style="max-width: 900px;">
          <div class="modalHeader">
              <h3>Datenschutzerkl√§rung</h3>
              <button class="btn-ghost" id="closeDatenschutzBtn" type="button">Schlie√üen</button>
          </div>
          <div class="modalBody" style="max-height: 70vh; overflow-y: auto; font-family: Arial, sans-serif; font-size: 13px; line-height: 1.6; color: #1f2d2a;">
              <!-- Contenido de la pol√≠tica de privacidad se cargar√° aqu√≠ -->
          </div>
      </div>
  </div>

  <script>
      // ====== CONFIGURATION ======
      const STORAGE_PREFIX = "boess_lcm_funksysteme_v_";
      const VERSION = "2.0.2";

      // Lista de sub-checks que deben ser N/A en modo b√°sico
      const BASIC_MODE_NA_ITEMS = [
          "DAB RX-Pegel Donor",
          "DAB C/N",
          "SK FB RX-Pegel UKW",
          "SK FB RX-Pegel DAB",
          "SK FB RX-Pegel PYC",
          "SK FB TX-Pegel UKW",
          "SK FB TX-Pegel DAB",
          "SK FB TX-Pegel PYC",
          "SK FB RL-Messung Status",
          "SK FB RL-Messung",
          "SK FB PIM-Messung Status",
          "SK FB PIM-Messung",
          "SK FB PIM Messung neu",
          "SK WELK TX-Pegel PYC",
          "SK WELK RX-Pegel PYC",
          "SK WELK PP Frequenzen",
          "SK WELK RX-Pegel PP",
          "SK SISTO PYC",
          "SK SISTO TX-Pegel PYC",
          "SK SISTO RX-Pegel PYC",
          "SK SISTO PP Status",
          "SK SISTO PP Frequenzen",
          "SK SISTO RX-Pegel PP",
          "IHV TZ Status",
          "IHV TZ Status PYC",
          "IHV TZ Status PP",
          "IHV TZ Status PP Frequenz",
          "IHV TZ Status RX-Pegel PP"
      ];

      // ====== INFORMACI√ìN DE SUB-CHECKS ======
      const SUBCHECK_INFO = {
          "UKW-Status": {
              question: "Ist die UKW Anlage zur√ºckgebaut? Ausgeschaltet?",
              notes: "Pr√ºfen Sie, ob die UKW-Anlage ordnungsgem√§√ü au√üer Betrieb gesetzt wurde."
          },
          "Hersteller": {
              question: "Wer ist der Hersteller der Anlage?",
              notes: "Notieren Sie den Hersteller f√ºr die Dokumentation."
          },
          "DAB-Status": {
              question: "DAB+ Anlage vorhanden?",
              notes: "√úberpr√ºfen Sie, ob eine DAB+ Anlage installiert ist."
          },
          "DAB Ensembles": {
              question: "Wie viele und welche Ensembles sind aufgeschaltet?",
              notes: "Listen Sie alle aktiven DAB+ Ensembles auf."
          },
          "DAB Reserve": {
              question: "Wie viel Reserve ist noch vorhanden? (Wie manches Ensemble kann noch aufgeschaltet werden?)",
              notes: "Pr√ºfen Sie die verf√ºgbare Kapazit√§t f√ºr zus√§tzliche Ensembles."
          },
          "DAB RX-Pegel Donor": {
              question: "Wie hoch ist der DAB+ Aussenpegel? Ist dieser Ausreichend?",
              notes: "Messen Sie den Empfangspegel und bewerten Sie die Qualit√§t."
          },
          "DAB C/N": {
              question: "DAB √ºberpr√ºfen (S/N Ratio)",
              notes: "Pr√ºfen Sie das Signal-Rausch-Verh√§ltnis (C/N Ratio)."
          },
          "ESA Status": {
              question: "Ist eine ESA vorhanden?",
              notes: "√úberpr√ºfen Sie, ob eine Einsprechanlage (ESA) installiert ist."
          },
          "ESA Funktion": {
              question: "Funktioniert die ESA auf allen Sendern/Ensembles?",
              notes: "Testen Sie die Funktion auf UKW und DAB+ Kan√§len."
          },
          "ESA Qualit√§t": {
              question: "Wie gut verst√§ndlich ist die Qualit√§t der Einsprechung auf den UKW und DAB+ Kan√§len? (1 = ungen√ºgend, 2 = gen√ºgend, 3 = gut)",
              notes: "Bewerten Sie die Sprachqualit√§t auf einer Skala von 1-3."
          },
          "ESA RadioText": {
              question: "Was wird auf dem RDS Display der Radios angezeigt? RDS ist obsolet - jedoch sollte TA auf DAB-Radio angezeigt werden",
              notes: "√úberpr√ºfen Sie die angezeigten Informationen auf den Radiodisplays."
          },
          "Analogfunk Status": {
              question: "Ist noch eine Analogfunkanlage f√ºr Blaulichtorganisationen eingebaut? Ist die Anlage r√ºckgebaut?",
              notes: "Pr√ºfen Sie den Status der Analogfunkanlage f√ºr Einsatzorganisationen."
          },
          "PYC Status": {
              question: "Wie sind die Polycom (PYC) repeater angebunden? 4/4 oder 8/8?",
              notes: "√úberpr√ºfen Sie die Anbindungskonfiguration der Polycom Repeater."
          },
          "Repeater Funktion": {
              question: "Wie verst√§rken die Repeater - Bandselektiv oder Kanalselektiv? Wichtig im Falle eines Frequenz-Refarming",
              notes: "Pr√ºfen Sie die Verst√§rkungsmethode der Repeater."
          },
          "SK FB Status": {
              question: "Wie ist der Zustand der Kabel (insbesondere im Aussenbereich UV-Einstrahlung)?",
              notes: "√úberpr√ºfen Sie den physikalischen Zustand der Kabelanlage."
          },
          "SK FB Stecker Status": {
              question: "Wie ist der Zustand der Steckverbindungen?",
              notes: "Pr√ºfen Sie alle Steckverbindungen auf Korrosion und festen Sitz."
          },
          "SK FB RX-Pegel UKW": {
              question: "Sind die Empfangspegel UKW im Tunnel noch in Ordnung?",
              notes: "Messen Sie die UKW-Empfangspegel an verschiedenen Punkten im Tunnel."
          },
          "SK FB RX-Pegel DAB": {
              question: "Sind die Empfangspegel DAB+ im Tunnel noch in Ordnung?",
              notes: "Messen Sie die DAB+ Empfangspegel im Tunnel."
          },
          "SK FB RX-Pegel PYC": {
              question: "Sind die Empfangspegel POLYCOM im Tunnel noch in Ordnung?",
              notes: "√úberpr√ºfen Sie die POLYCOM Empfangspegel."
          },
          "SK FB TX-Pegel UKW": {
              question: "Sind die Sendepegel UKW am Koppelfeldausgang in Ordnung?",
              notes: "Messen Sie die UKW-Sendepegel am Koppelfeld."
          },
          "SK FB TX-Pegel DAB": {
              question: "Sind die Sendepegel DAB+ am Koppelfeldausgang in Ordnung?",
              notes: "Messen Sie die DAB+ Sendepegel am Koppelfeld."
          },
          "SK FB TX-Pegel PYC": {
              question: "Sind die Sendepegel POLYCOM am Koppelfeldausgang in Ordnung?",
              notes: "Pr√ºfen Sie die POLYCOM Sendepegel am Koppelfeld."
          },
          "SK FB RL-Messung Status": {
              question: "R√ºckflussd√§mpfung (RL): Wann wurde diese Messung das letzte Mal gemacht?",
              notes: "Dokumentieren Sie das Datum der letzten RL-Messung."
          },
          "SK FB RL-Messung": {
              question: "Ist die R√ºckflussd√§mpfung in Ordnung? (RL)",
              notes: "√úberpr√ºfen Sie die R√ºckflussd√§mpfungswerte."
          },
          "SK FB PIM-Messung Status": {
              question: "PIM Messung: Wann wurde diese Messung das letzte mal gemacht?",
              notes: "Notieren Sie das Datum der letzten PIM-Messung."
          },
          "SK FB PIM-Messung": {
              question: "PIM Messung: Sind die PIM Werte in Ordnung?",
              notes: "Pr√ºfen Sie die PIM (Passive Intermodulation) Werte."
          },
          "SK FB PIM Messung neu": {
              question: "Ist eine neue PIM Messung notwendig?",
              notes: "Bewerten Sie, ob eine neue PIM-Messung erforderlich ist."
          },
          "SK WELK Status": {
              question: "Sind WELK(s) SK installiert?",
              notes: "√úberpr√ºfen Sie, ob WELK-Systeme vorhanden sind."
          },
          "SK WELK PYC": {
              question: "Ist Polycom auf diesem Aufgeschaltet?",
              notes: "Pr√ºfen Sie die POLYCOM-Integration im WELK-System."
          },
          "SK WELK TX-Pegel PYC": {
              question: "Sind die Sendepegel POLYCOM am Koppelfeldausgang in Ordnung?",
              notes: "Messen Sie die POLYCOM Sendepegel im WELK-System."
          },
          "SK WELK RX-Pegel PYC": {
              question: "Funktioniert POLYCOM im WELK?",
              notes: "Testen Sie die POLYCOM-Funktionalit√§t im WELK-System."
          },
          "SK WELK PP Status": {
              question: "Welche Public Provider sind auf dem SK aufgeschaltet?",
              notes: "Listen Sie alle aktiven Mobilfunkprovider auf."
          },
          "SK WELK PP Frequenzen": {
              question: "Welche Frequenzb√§nder?",
              notes: "Dokumentieren Sie die verwendeten Frequenzb√§nder."
          },
          "SK WELK RX-Pegel PP": {
              question: "Wie ist die Empfangsqualit√§t am weitest entferntesten Versorgungspunkt des SKs?",
              notes: "Messen Sie die Empfangsqualit√§t an kritischen Punkten."
          },
          "SK SISTO Status": {
              question: "Sind SISTO SK installiert?",
              notes: "√úberpr√ºfen Sie, ob SISTO-Systeme vorhanden son."
          },
          "SK SISTO PYC": {
              question: "Ist Polycom auf diesem Aufgeschaltet?",
              notes: "Pr√ºfen Sie die POLYCOM-Integration im SISTO-System."
          },
          "SK SISTO TX-Pegel PYC": {
              question: "Sind die Sendepegel POLYCOM am Koppelfeldausgang in Ordnung?",
              notes: "Messen Sie die POLYCOM Sendepegel im SISTO-System."
          },
          "SK SISTO RX-Pegel PYC": {
              question: "Funktioniert POLYCOM im SISTO?",
              notes: "Testen Sie die POLYCOM-Funktionalit√§t im SISTO-System."
          },
          "SK SISTO PP Status": {
              question: "Welche Mobilfunkprovider sind auf dem SK aufgeschaltet?",
              notes: "Listen Sie alle aktiven Mobilfunkprovider auf."
          },
          "SK SISTO PP Frequenzen": {
              question: "Welche Frequenzb√§nder?",
              notes: "Dokumentieren Sie die verwendeten Frequenzb√§nder."
          },
          "SK SISTO RX-Pegel PP": {
              question: "Wie ist die Empfangsqualit√§t am weitest entferntesten Versorgungspunkt des SKs?",
              notes: "Messen Sie die Empfangsqualit√§t an kritischen Punkten."
          },
          "IHV TZ Status": {
              question: "Ist die Tunnelzentrale mit Tunnelfunk erschlossen und wie?",
              notes: "Pr√ºfen Sie die Funkversorgung der Tunnelzentrale."
          },
          "IHV TZ Status PYC": {
              question: "Ist Polycom auf diesem Aufgeschaltet?",
              notes: "√úberpr√ºfen Sie die POLYCOM-Integration in der Tunnelzentrale."
          },
          "IHV TZ Status PP": {
              question: "Welche Mobilfunkprovider sind auf aufgeschaltet?",
              notes: "Listen Sie alle aktiven Provider in der Tunnelzentrale auf."
          },
          "IHV TZ Status PP Frequenz": {
              question: "Welche Frequenzb√§nder?",
              notes: "Dokumentieren Sie die verwendeten Frequenzb√§nder."
          },
          "IHV TZ Status RX-Pegel PP": {
              question: "Wie ist die Empfangsqualit√§t am weitest entferntesten Versorgungspunkt der Inhouseinstallation?",
              notes: "Messen Sie die Empfangsqualit√§t an kritischen Punkten."
          },
          "Technologiebeurteilung Ersatzteilproblematik": {
              question: "Technologiebeurteilung allgemein, gibt es neue Features?",
              notes: "Bewerten Sie den technologischen Stand und Ersatzteilverf√ºgbarkeit."
          },
          "Eigentumsverh√§ltnis": {
              question: "Eigentumsverh√§ltnis falls spezielles",
              notes: "Dokumentieren Sie spezielle Eigentumsverh√§ltnisse."
          },
          "Physikalischen Infrastruktur": {
              question: "Antennen und Aussenanlagen Zustand, Eigentum Metallkonstruktionen, Masten, Vorbaurohre etc. Bei S√∂ll-Steigschutzleitern Wartung gem√§ss SUVA einmal j√§hrlich",
              notes: "√úberpr√ºfen Sie den Zustand der physischen Infrastruktur."
          },
          "Normen": {
              question: "Welcher Typ Kabel? (Themen wie halogenfrei, Brandverhaltenklasse)",
              notes: "Pr√ºfen Sie die verwendeten Kabeltypen und Normen."
          },
          "SPS": {
              question: "SAIA SPS SPH KF.SE13 (Comlab spezifisch) - Diese SPS enth√§lt einen Akku dieser sollte alle drei Jahre ausgebaut und gepr√ºft werden.",
              notes: "Die Pr√ºfung umfasst eine Spannungsmessung und eine kontrollierte Entladung zur Feststellung der Kapazit√§t."
          },
          "Repeater & SPS Konfiguration": {
              question: "Neuestes ConfigFile/Backup der Anlage vorhanden?",
              notes: "√úberpr√ºfen Sie die Verf√ºgbarkeit aktueller Konfigurationsbackups."
          },
          "FO Status": {
              question: "LWL-Schnittstelle PYC BTS",
              notes: "Pr√ºfen Sie den Status der LWL-Schnittstelle f√ºr POLYCOM BTS."
          },
          "TPS Status": {
              question: "Pager Service vorhanden & OK",
              notes: "√úberpr√ºfen Sie den Status des Pager-Services."
          }
      };

      // Informaci√≥n para sub-checks sin datos espec√≠ficos
      const DEFAULT_SUBCHECK_INFO = {
          question: "Pr√ºfpunkt-Spezifikation",
          notes: "Diese Pr√ºfung dient der √úberwachung und Dokumentaci√≥n des Systemzustands. Bitte f√ºhren Sie eine Sichtpr√ºfung und gegebenenfalls Messungen durch."
      };

      // ====== STATE MANAGEMENT ======
      let state = {
          anlage: "",
          tunnel: "",
          name: "",
          mode: "basic",
          groups: [],
          useRadioMode: true,
          originalStates: new Map()
      };

      // ====== ELEMENT REFERENCES ======
      const elSetupCard = document.getElementById("setupCard");
      const elAppCard = document.getElementById("appCard");
      const elAnlage = document.getElementById("anlageSelect");
      const elTunnel = document.getElementById("tunnelSelect");
      const elStart = document.getElementById("startBtn");
      const elHint = document.getElementById("setupHint");
      const elSetupProgress = document.getElementById("setupProgress");
      const elGroups = document.getElementById("groups");
      const elListName = document.getElementById("listName");
      const elCounter = document.getElementById("counter");
      const elStatus = document.getElementById("status");
      const elStatusSummary = document.getElementById("statusSummary");
      const elNewGroupTitle = document.getElementById("newGroupTitle");
      const elModeRadios = Array.from(document.querySelectorAll('input[name="mode"]'));
      const elBasicMode = document.getElementById("basicMode");
      const elDetailedMode = document.getElementById("detailedMode");
      const elMetaChip = document.getElementById("metaChip");
      const elProgressBig = document.getElementById("progressBig");
      const elExportBtn = document.getElementById("exportBtn");
      const elExportPanel = document.getElementById("exportPanel");
      const elExportWordBtn = document.getElementById("exportWordBtn");
      const elExportExcelBtn = document.getElementById("exportExcelBtn");
      const elHelpModal = document.getElementById("helpModal");
      const elDatenschutzModal = document.getElementById("datenschutzModal");
      const elSaveIndicator = document.getElementById("saveIndicator");
      const elCompatModal = document.getElementById("compatModal");
      const elCompatAlert = document.getElementById("compatAlert");
      const elAlertMessage = document.getElementById("alertMessage");

      // ====== COMPATIBILITY FUNCTIONS ======
      function initCompatibilityCheck() {
          const issues = [];
          const warnings = [];
          
          // Check if running from file://
          const isFileProtocol = window.location.protocol === 'file:';
          if (isFileProtocol) {
              issues.push("LIMITIERUNG: L√§uft von Datei (file://)");
              issues.push("- localStorage kann eingeschr√§nkt sein");
              issues.push("- Manche Browser blockieren Downloads");
              issues.push("");
              issues.push("EMPFEHLUNG: Lokalen Server nutzen");
              issues.push("python -m http.server 8000");
              issues.push("http://localhost:8000 √∂ffnen");
          }
          
          // Check localStorage
          let localStorageAvailable = false;
          try {
              localStorage.setItem('test', 'test');
              localStorage.removeItem('test');
              localStorageAvailable = true;
          } catch (e) {
              issues.push("WARNUNG: localStorage nicht verf√ºgbar");
              issues.push("- Daten werden nicht gespeichert");
              issues.push("- Bitte Browser-Einstellungen pr√ºfen");
          }
          
          // Show alert if issues
          if (issues.length > 0) {
              setTimeout(() => {
                  showCompatAlert(issues.join('\n'));
              }, 1500);
          }
          
          // Update compatibility status
          updateCompatStatus(isFileProtocol, localStorageAvailable);
          
          // Initialize body
          document.body.classList.add('loaded');
      }
      
      function updateCompatStatus(isFileProtocol, localStorageAvailable) {
          const fileStatus = document.getElementById('fileProtocolStatus');
          const docxStatus = document.getElementById('docxStatus');
          const xlsxStatus = document.getElementById('xlsxStatus');
          const localStorageStatus = document.getElementById('localStorageStatus');
          
          // File protocol status
          if (isFileProtocol) {
              fileStatus.innerHTML = '<span class="status-indicator status-warning"></span> L√§uft von Datei (file://) - Eingeschr√§nkte Funktionalit√§t';
          } else {
              fileStatus.innerHTML = '<span class="status-indicator status-ok"></span> L√§uft von Server - Volle Funktionalit√§t';
          }
          
          // Check dependencies after a delay
          setTimeout(() => {
              // docx status
              if (typeof docx === 'undefined') {
                  docxStatus.innerHTML = '<span class="status-indicator status-warning"></span> Word-Export: Ben√∂tigt Internet';
              } else {
                  docxStatus.innerHTML = '<span class="status-indicator status-ok"></span> Word-Export: Verf√ºgbar';
              }
              
              // xlsx status
              if (typeof XLSX === 'undefined') {
                  xlsxStatus.innerHTML = '<span class="status-indicator status-warning"></span> Excel-Export: Ben√∂tigt Internet';
              } else {
                  xlsxStatus.innerHTML = '<span class="status-indicator status-ok"></span> Excel-Export: Verf√ºgbar';
              }
          }, 2000);
          
          // localStorage status
          if (localStorageAvailable) {
              localStorageStatus.innerHTML = '<span class="status-indicator status-ok"></span> Lokale Speicherung: Aktiv';
          } else {
              localStorageStatus.innerHTML = '<span class="status-indicator status-error"></span> Lokale Speicherung: Nicht verf√ºgbar';
          }
      }
      
      function showCompatAlert(message) {
          elAlertMessage.textContent = "Die App l√§uft mit eingeschr√§nkter Funktionalit√§t. Klicken Sie auf 'L√∂sung' f√ºr Details.";
          elCompatAlert.style.display = 'block';
          
          // Auto-hide after 30 seconds
          setTimeout(() => {
              if (elCompatAlert.style.display === 'block') {
                  elCompatAlert.style.display = 'none';
              }
          }, 30000);
      }
      
      function hideCompatAlert() {
          elCompatAlert.style.display = 'none';
      }
      
      function showCompatModal() {
          elCompatModal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          updateCompatStatus(
              window.location.protocol === 'file:',
              (() => {
                  try {
                      localStorage.setItem('test', 'test');
                      localStorage.removeItem('test');
                      return true;
                  } catch {
                      return false;
                  }
              })()
          );
      }
      
      function hideCompatModal() {
          elCompatModal.style.display = 'none';
          document.body.style.overflow = '';
      }
      
      function downloadPortableVersion() {
          const htmlContent = document.documentElement.outerHTML;
          
          // Add instructions to the HTML
          const modifiedContent = htmlContent.replace(
              '</head>',
              `<!-- 
  BOESS Checklist System - Portable Version
  =========================================
  
  ANLEITUNG F√úR OPTIMALE NUTZUNG:
  1. MIT SERVER (Empfohlen):
     - Terminal/CMD √∂ffnen in diesem Ordner
     - Befehl eingeben: python -m http.server 8000
     - Browser √∂ffnen: http://localhost:8000
  
  2. OHNE SERVER (Eingeschr√§nkt):
     - Direkt index.html im Browser √∂ffnen
     - PDF und CSV Export funktionieren
     - Word/Excel ben√∂tigen Internet
     - Speicherung kann eingeschr√§nkt sein
  
  HINWEIS: F√ºr beste Ergebnisse immer lokalen Server verwenden!
  -->\n</head>`
          );
          
          const blob = new Blob([modifiedContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'boess-checklist-portable.html';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          alert('Portable Version heruntergeladen!\n\nF√ºr volle Funktionalit√§t:\n1. Lokalen Server starten: python -m http.server 8000\n2. Browser √∂ffnen: http://localhost:8000');
      }

      // ====== HELPER FUNCTIONS ======
      function uid() {
          return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
      }

      function storageKey(anlage, tunnel){
          return STORAGE_PREFIX + (anlage || "NA") + "_" + (tunnel || "NA");
      }

      function fileSafeName(name){
          return (name || "export").replace(/[\\/:*?"<>|]+/g, "-").trim();
      }

      function downloadBlob(blob, filename){
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(a.href), 60000);
      }

      function modeLabel(mode){
          return mode === "detailed"
              ? "Detailinspektion (visuell, mit Messungen, Vergleich mit Dokumenten und/oder fr√ºheren Revisionen)"
              : "Basisinspektion (visuell, ohne Messungen)";
      }

      function statusLabel(status){
          switch(status) {
              case "ok": return "OK";
              case "nok": return "Nicht OK";
              case "na": return "N/A";
              default: return "Ausstehend";
          }
      }

      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
      }

      // FUNCIONES DE FECHA
      function formatDateForHeader(date) {
        return date.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      function formatDateForFooter(date) {
        return date.toLocaleString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // ====== FUNCIONES PARA MODAL DE INFORMACI√ìN ======
      function showSubcheckInfo(subcheckTitle) {
          const info = SUBCHECK_INFO[subcheckTitle] || DEFAULT_SUBCHECK_INFO;
          const modal = document.getElementById('subcheckInfoModal');
          const titleElement = document.getElementById('subcheckInfoTitle');
          const bodyElement = document.getElementById('subcheckInfoBody');
          
          titleElement.textContent = subcheckTitle;
          
          let bodyHTML = `
              <div class="subcheck-info-question">
                  <strong>Pr√ºffrage:</strong><br>
                  ${escapeHtml(info.question)}
              </div>`;
          
          if (info.notes) {
              bodyHTML += `
                  <div class="subcheck-info-notes">
                      <strong>Hinweise:</strong><br>
                      ${typeof info.notes === 'string' ? escapeHtml(info.notes) : info.notes}
                  </div>`;
          }
          
          if (info.details) {
              bodyHTML += `
                  <div class="subcheck-info-notes">
                      <strong>Details:</strong><br>
                      ${escapeHtml(info.details)}
                  </div>`;
          }
          
          bodyElement.innerHTML = bodyHTML;
          modal.classList.add('open');
          
          document.body.style.overflow = 'hidden';
      }

      function hideSubcheckInfo() {
          const modal = document.getElementById('subcheckInfoModal');
          modal.classList.remove('open');
          document.body.style.overflow = '';
      }
      
      // ====== FUNCIONES PARA MODAL DE DATENSCHUTZ ====== 
      function showDatenschutzModal() {
          const modal = document.getElementById('datenschutzModal');
          const helpModal = document.getElementById('helpModal');
          
          if (helpModal) helpModal.style.display = 'none';
          
          const datenschutzContent = `
              <section id="datenschutz" style="font-family: Arial, sans-serif; font-size: 13px; line-height: 1.6; color: #1f2d2a; max-width: 900px;">
                  <div style="
                      display:flex;
                      justify-content:space-between;
                      align-items:flex-end;
                      gap:24px;
                      margin-bottom: 10px;
                  ">
                      <h3 style="
                          color:#07694D;
                          border-bottom:2px solid #07694D;
                          padding-bottom:6px;
                          font-family: Calibri, Arial, sans-serif;
                          margin:0;
                      ">
                          Datenschutzerkl√§rung
                      </h3>

                      <img
                          alt="Boess Engineering AG Logo"
                          style="height:72px; width:auto; display:block;"
                           src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAS4AAABmCAYAAAB1PHz2AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABNaSURBVHhe7Z1PbBtHlsY/i74k68XSURJddsCG6ERzmGh0y0qLqAnSOiSjwDnHgDsigeSWgWMg6zEwlMhBAl9sY+a2B9FqYZS7Y2UPcSiwDViTHOXJxY41KiKXaCIF1iGTS4TeQ/drVReryeY/2+38H9CwWV2sKja7P1V9eu/xmOu6LhiGYRJEiFrAMAzzpMPCxTBM4mDhYhgmcbBwMQyTOFi4GIZJHCxcDMMkDhYuhmESBwsXwzCJg4WLYZjEwcLFMEziYOFiGCZxsHAxDJM4WLgYhkkcLFwMwyQOFi4GYRIHCxfDMImDhYthmMTBwsUwTOJg4WIYJnGwcDEMkzhYuBiGSRwsXAzDJA4WLoZhEgcLF8MwiYOFi2GYxMHCxTBM4mDhYhgmcbBwMQyTOFi4GIZJHCxcDMMkDhYuhmESBwsXwzCJg4WLYZjEwcLFMEziYOFiGCZxsHAxDJM4WLgYhkkcLFwMwyQOFi4GYRIHCxfDMImDhYthmMTBwsUwTOJg4WIYJnGwcDEMkzhYuBiGSRwsXAzDJA4WLoZhEgcLF8MwiYOFi2GYxMHCxTBM4mDhYhgmcbBwMQyTOFi4GIZJHCxcDMMkDhYuhmESBwsXwzCJg4WLYZjEwcLFMEziYOFiGCZxsHAxDJM4WLgYhkkcLFwMwyQOFi4GYRIHCxfDMImDhYthmMTBwsUwTOJg4WIYJnGwcDEMkzhYuBiGSRwsXAzDJA4WLoZhEgcLF8MwiYOFi2GYxMHCxTBM4mDhYhgmcbBwMQyTOFi4GIZJHCxcDMMkDhYuhmESBwsXwzCJg4WLYZjEwcLFMEziYOFiGCZxsHAxDJM4WLgYhkkcLFwMwyQOFi6GYRIHCxfDMInj/wAY/qrrW7N5QQAAAABJRU5ErkJggg=="
                      />
                  </div>

                  <p>
                      Der Schutz Ihrer personenbezogenen Daten ist der
                      <strong style="color:#07694D;">Boess Engineering AG</strong>
                      ein wichtiges Anliegen. Wir verarbeiten personenbezogene Daten
                      ausschlie√ülich im Einklang mit dem revidierten Schweizer
                      Datenschutzgesetz (DSG).
                  </p>

                  <div style="
                      background:#f1f7f5;
                      border-left:4px solid #07694D;
                      padding:12px;
                      margin:16px 0;
                  ">
                      <strong style="font-family: Calibri, Arial, sans-serif;">Verantwortliche Stelle</strong><br>
                      Boess Engineering AG<br>
                      Wankdorffeldstrasse 64<br>
                      CH-3014 Bern<br>
                      Schweiz<br>
                      Tel. +41 31 330 10 50<br>
                      <a href="mailto:info@boess.ch" style="color:#07694D; text-decoration:none;">
                          info@boess.ch
                      </a>
                  </div>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Verarbeitung personenbezogener Daten</h4>
                  <p>
                      Personenbezogene Daten werden nur verarbeitet, soweit dies f√ºr
                      den Betrieb dieser Website, die Kommunikation mit Ihnen oder
                      aus technischen Gr√ºnden erforderlich ist.
                  </p>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Server-Logs</h4>
                  <p>
                      Beim Zugriff auf unsere Website werden automatisch technische
                      Daten wie IP-Adresse, Datum und Uhrzeit, Browsertyp und
                      Betriebssystem in Server-Logfiles erfasst. Diese Daten dienen
                      ausschlie√ülich der Sicherstellung des technischen Betriebs
                      und der Systemsicherheit.
                  </p>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Cookies</h4>
                  <p>
                      Diese Website verwendet ausschlie√ülich technisch notwendige
                      Cookies. Es findet kein Tracking und keine Profilbildung statt.
                  </p>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Kontaktaufnahme</h4>
                  <p>
                      Wenn Sie uns per E-Mail oder Formular kontaktieren, werden Ihre
                      Angaben zur Bearbeitung der Anfrage verarbeitet. Eine Weitergabe
                      an Dritte erfolgt nicht.
                  </p>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Weitergabe und Speicherung</h4>
                  <p>
                      Ihre Daten werden nicht an Dritte weitergegeben und nur so lange
                      gespeichert, wie dies f√ºr den jeweiligen Zweck erforderlich ist
                      oder gesetzliche Aufbewahrungspflichten bestehen.
                  </p>

                  <h4 style="color:#0a7f5c; font-family: Calibri, Arial, sans-serif;">Ihre Rechte</h4>
                  <p>
                      Sie haben das Recht auf Auskunft, Berichtigung und L√∂schung Ihrer
                      personenbezogenen Daten im Rahmen der gesetzlichen Bestimmungen
                      des Schweizer DSG.
                  </p>

                  <p style="margin-top:20px; font-size:11px; color:#6b8f84;">
                      Stand: 2026 ¬∑ Boess Engineering AG
                  </p>
              </section>
          `;
          
          const modalBody = modal.querySelector('.modalBody');
          modalBody.innerHTML = datenschutzContent;
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }

      function hideDatenschutzModal() {
          const modal = document.getElementById('datenschutzModal');
          modal.style.display = 'none';
          document.body.style.overflow = '';
      }

      // ====== SETUP FUNCTIONS ======
      function setSetupState(){
          const a = elAnlage.value;
          const t = elTunnel.value;
          elStart.disabled = !(a && t);
          const pct = (!a ? 0 : (!t ? 50 : 100));
          elSetupProgress.style.width = pct + "%";

          elHint.textContent = a
              ? (t ? "Bereit. Du kannst starten." : "Bitte Tunnel ausw√§hlen.")
              : "Bitte zuerst Teilanlage ausw√§hlen.";

          elMetaChip.textContent = `${a || "GE??"} ¬∑ ${t && t !== "__manual__" ? t : "Tunnel"}`;
      }

      function getTunnelsByAnlage(anlage){
        const GE08 = [
              "TUNNEL Birchi",
              "TUNNEL L√ºsslingen",
              "TUNNEL Spitalhof",
              "TUNNEL Grenchner Witi",
              "TUNNEL Eggflue",
              "TUNNEL Reinach",
              "TUNNEL Schwarzwald",
              "GALLERIE Breite",
              "TUNNEL Singer (SN)",
              "TUNNEL Pratteler",
              "TUNNEL Schweizerhalle",
              "TUNNEL St. Johann inkl Luzernerring",
              "TUNNEL Horburg",
              "TUNNEL Arisdorf",
              "TUNNEL Ebenrain",
              "TUNNEL Belchen",
              "TUNNEL Sch√∂nthal",
              "GALLERIE Neuenhof",
              "TUNNEL Baregg",
              "TUNNEL Habsburg",
              "TUNNEL Schinznacherfeld",
              "TUNNEL B√∂zberg"

          ];          
          const GE10 = [
              "TUNNEL Sachseln",
              "TUNNEL TB Zollhaus",
              "TUNNEL Giswil",
              "TUNNEL Kirchenwald inkl. Verbindung N02-N08 VZ Lopper (R4)",
              "TUNNEL Lopper inkl. Abzweigung N08-N02 VZ Lopper (R3)",
              "TUNNEL Acheregg Nord R4 AS Hergiswil, (inkl. Gallerie Stansstad)",
              "TUNNEL TB Rathausen",
              "TUNNEL Reussport",
              "TUNNEL TB AS Luzern-Zentrum",
              "TUNNEL Sonnenberg",
              "TUNNEL TB Schlund",
              "TUNNEL TB Spier inkl Kantonstrasse",
              "TUNNEL Lungern",
              "TUNNEL Eich"
          ];
          const GE11 = [
              "TUNNEL Gotthard (GST)",
              "TUNNEL Seelisberg",
              "TUNNEL Umfahrung Fl√ºelen",
              "TUNNEL Mosi",
              "GALLERIA Costoni di Fieud",
              "TUNNEL Teiftal",
              "TUNNEL Platti",
              "TUNNEL Naxberg",
              "Tunnel Axenfluh",
              "TUNNEL √ñlberg",
              "TUNNEL Zingel",
              "TUNNEL Langlaui",
              "TUNNEL Stutzegg",
              "TUNNEL Ried",
              "TUNNEL Tellsplatte",
              "TUNNEL Kleine Galerie",
              "TUNNEL Schiferenegg",
              "Tunnel Buggital",
              "Tunnel Gumpisch"
          ];
          if (anlage === "GE10") return GE10;
          if (anlage === "GE11") return GE11;
          if (anlage === "GE08") return GE08;
          return [];
      }

      function populateTunnelSelect(){
          const a = elAnlage.value;
          const tunnels = getTunnelsByAnlage(a);
          elTunnel.innerHTML = '<option value="">Tunnel ausw√§hlen‚Ä¶</option>';

          if (!a){
              elTunnel.disabled = true;
              setSetupState();
              return;
          }

          elTunnel.disabled = false;

          if (tunnels.length === 0){
              const opt = document.createElement("option");
              opt.value = "__manual__";
              opt.textContent = "‚Äî Keine Liste hinterlegt (Tunnel manuell eingeben) ‚Äî";
              elTunnel.appendChild(opt);
              setSetupState();
              return;
          }

          for (const t of tunnels){
              const opt = document.createElement("option");
              opt.value = t;
              opt.textContent = t;
              elTunnel.appendChild(opt);
          }
          setSetupState();
      }

      function askManualTunnelIfNeeded(){
          if (elTunnel.value !== "__manual__") return elTunnel.value;
          const name = prompt("Tunnelname f√ºr " + elAnlage.value + " eingeben:");
          if (!name) return "";
          const opt = document.createElement("option");
              opt.value = name;
              opt.textContent = name;
              elTunnel.appendChild(opt);
              elTunnel.value = name;
              return name;
      }

      // ====== CORE DATA FUNCTIONS ======
      function computeStats() {
          let ok = 0, nok = 0, na = 0, pending = 0, total = 0;

          for (const g of state.groups){
              for (const i of (g.items || [])){
                  total++;
                  switch(i.status) {
                      case "ok": ok++; break;
                      case "nok": nok++; break;
                      case "na": na++; break;
                      default: pending++;
                  }
              }
          }

          const done = ok + nok + na;
          const pct = total ? Math.round((done/total)*100) : 0;

          return { ok, nok, na, pending, total, done, pct };
      }

      function load() {
          const a = state.anlage;
          const t = state.tunnel;
          const key = storageKey(a, t);
          try {
              const raw = localStorage.getItem(key);
              state = raw ? JSON.parse(raw) : {
                  anlage: a,
                  tunnel: t,
                  name: "",
                  mode: "basic",
                  groups: [],
                  useRadioMode: true,
                  originalStates: new Map()
              };

              if (!state || typeof state !== "object") {
                  state = {
                      anlage: a,
                      tunnel: t,
                      name: "",
                      mode: "basic",
                      groups: [],
                      useRadioMode: true,
                      originalStates: new Map()
                  };
              }

              if (!Array.isArray(state.groups)) state.groups = [];
              if (typeof state.name !== "string") state.name = "";
              if (state.mode !== "basic" && state.mode !== "detailed") state.mode = "basic";
              if (typeof state.useRadioMode !== "boolean") state.useRadioMode = true;

              if (state.originalStates && !(state.originalStates instanceof Map)) {
                  state.originalStates = new Map(Object.entries(state.originalStates));
              } else if (!state.originalStates) {
                  state.originalStates = new Map();
              }

              state.anlage = a;
              state.tunnel = t;

              migrateOldItems();
              saveOriginalStates();

          } catch {
              state = {
                  anlage: a,
                  tunnel: t,
                  name: "",
                  mode: "basic",
                  groups: [],
                  useRadioMode: true,
                  originalStates: new Map()
              };
          }

          elListName.value = state.name || "";
          elModeRadios.forEach(r => r.checked = (r.value === state.mode));
          document.title = `BOESS Checklist ‚Äì ${state.anlage} ¬∑ ${state.tunnel}`;
          elMetaChip.textContent = `${state.anlage} ¬∑ ${state.tunnel}`;

          if (state.mode === "basic") {
              applyBasicModeNA();
          }
      }

      function saveOriginalStates() {
          for (const group of state.groups) {
              for (const item of group.items) {
                  const itemId = item.id;
                  if (!state.originalStates.has(itemId)) {
                      state.originalStates.set(itemId, {
                          status: item.status,
                          note: item.note || ""
                      });
                  }
              }
          }
      }

      function migrateOldItems() {
          for (const group of state.groups) {
              for (const item of group.items) {
                  if (item.done !== undefined && item.status === undefined) {
                      item.status = item.done ? "ok" : "pending";
                      delete item.done;
                  }
                  if (!item.status) {
                      item.status = "pending";
                  }
              }
          }
      }

      function save() {
          const key = storageKey(state.anlage, state.tunnel);

          const stateToSave = {
              ...state,
              originalStates: Object.fromEntries(state.originalStates)
          };

          localStorage.setItem(key, JSON.stringify(stateToSave));
          
          elSaveIndicator.style.display = 'inline-block';
          elSaveIndicator.style.animation = 'pulse 1s ease';
          setTimeout(() => {
              elSaveIndicator.style.display = 'none';
          }, 2000);
          
          elStatus.textContent = "Gespeichert ‚úì";
          clearTimeout(save._t);
          save._t = setTimeout(() => elStatus.textContent = "Wird automatisch im Browser gespeichert.", 900);
          updateSidebarStats();
      }

      function updateSidebarStats(){
          const { ok, nok, na, total, pct } = computeStats();

          elCounter.textContent = `${ok}/${total} (${pct}% ‚úì)`;
          elProgressBig.textContent = pct + "%";
          elStatusSummary.textContent = `‚úì:${ok} ‚úó:${nok} ‚Äì:${na}`;
          document.title = `BOESS Checklist ‚Äì ${state.anlage} ¬∑ ${state.tunnel} (${pct}%)`;
      }

      // ====== FUNCI√ìN PARA CAMBIO DE MODO ======
      function handleModeChange() {
          const oldMode = state.mode;
          const newMode = elBasicMode.checked ? "basic" : "detailed";

          if (oldMode !== newMode) {
              state.mode = newMode;

              if (newMode === "basic") {
                  applyBasicModeNA();
              } else {
                  restoreOriginalStates();
              }

              save();
              render();
          }
      }

      function applyBasicModeNA() {
          let changed = false;

          for (const group of state.groups) {
              for (const item of group.items) {
                  if (!state.originalStates.has(item.id)) {
                      state.originalStates.set(item.id, {
                          status: item.status,
                          note: item.note || ""
                      });
                  }

                  if (BASIC_MODE_NA_ITEMS.includes(item.title) && item.status !== "na") {
                      item.status = "na";
                      changed = true;
                  }
              }
          }

          if (changed) {
              save();
          }
      }

      function restoreOriginalStates() {
          let changed = false;

          for (const group of state.groups) {
              for (const item of group.items) {
                  if (state.originalStates.has(item.id)) {
                      const original = state.originalStates.get(item.id);

                      if (item.status !== original.status || item.note !== original.note) {
                          item.status = original.status;
                          item.note = original.note;
                          changed = true;
                      }
                  } else {
                      if (item.status === "na" && BASIC_MODE_NA_ITEMS.includes(item.title)) {
                          item.status = "pending";
                          changed = true;
                      }
                  }
              }
          }

          if (changed) {
              save();
          }
      }

      // ====== RENDERING FUNCTIONS ======
      function render() {
          elGroups.innerHTML = "";
          updateSidebarStats();

          if (state.groups.length === 0) {
              const empty = document.createElement("div");
              empty.className = "muted";
              empty.style.marginTop = "10px";
              empty.textContent = "Noch keine Pr√ºfpunkte. F√ºge oben einen Pr√ºfpunkt hinzu oder lade die Vorlage.";
              elGroups.appendChild(empty);
              return;
          }

          for (const g of state.groups) {
              const groupWrap = document.createElement("div");
              groupWrap.className = "group";

              const header = document.createElement("div");
              header.className = "groupHeader";

              const titleRow = document.createElement("div");
              titleRow.className = "groupTitleRow";

              const toggleBtn = document.createElement("button");
              toggleBtn.className = "btn-ghost";
              toggleBtn.textContent = g.collapsed ? "‚ñ∂" : "‚ñº";
              toggleBtn.title = g.collapsed ? "Ausklappen" : "Einklappen";
              toggleBtn.style.padding = "10px 12px";
              toggleBtn.addEventListener("click", () => {
                  g.collapsed = !g.collapsed;
                  save();
                  render();
              });

              const title = document.createElement("input");
              title.className = "groupTitle";
              title.value = g.title || "";
              title.title = "Pr√ºfpunkt umbenennen";
              title.addEventListener("change", () => {
                  g.title = title.value.trim() || "Unbenannt";
                  save();
                  render();
              });

              const progress = document.createElement("div");
              progress.className = "progress";
              const gOk = (g.items || []).filter(i => i.status === "ok").length;
              const gNok = (g.items || []).filter(i => i.status === "nok").length;
              const gNa = (g.items || []).filter(i => i.status === "na").length;
              progress.textContent = `${gOk}‚úì ${gNok}‚úó ${gNa}‚Äì`;

              titleRow.appendChild(toggleBtn);
              titleRow.appendChild(title);
              titleRow.appendChild(progress);

              const headerActions = document.createElement("div");
              headerActions.className = "row-tight";

              const setAllOkBtn = document.createElement("button");
              setAllOkBtn.className = "btn-soft";
              setAllOkBtn.textContent = "Alle ‚úì";
              setAllOkBtn.title = "Alle Sub-Checks in diesem Pr√ºfpunkt auf OK setzen";
              setAllOkBtn.addEventListener("click", () => {
                  g.items = (g.items || []).map(i => {
                      if (!state.originalStates.has(i.id)) {
                          state.originalStates.set(i.id, {
                              status: i.status,
                              note: i.note || ""
                          });
                      }

                      if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(i.title)) {
                          return { ...i, status: "na" };
                      }
                      return { ...i, status: "ok" };
                  });
                  save();
                  render();
              });

              const setAllNokBtn = document.createElement("button");
              setAllNokBtn.className = "btn-soft";
              setAllNokBtn.textContent = "Alle ‚úó";
              setAllNokBtn.title = "Alle Sub-Checks in diesem Pr√ºfpunkt auf Nicht OK setzen";
              setAllNokBtn.addEventListener("click", () => {
                  g.items = (g.items || []).map(i => {
                      if (!state.originalStates.has(i.id)) {
                          state.originalStates.set(i.id, {
                              status: i.status,
                              note: i.note || ""
                          });
                      }

                      if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(i.title)) {
                          return { ...i, status: "na" };
                      }
                      return { ...i, status: "nok" };
                  });
                  save();
                  render();
              });

              const resetAllBtn = document.createElement("button");
              resetAllBtn.className = "btn-soft";
              resetAllBtn.textContent = "Reset";
              resetAllBtn.title = "Alle Sub-Checks in diesem Pr√ºfpunkt zur√ºcksetzen";
              resetAllBtn.addEventListener("click", () => {
                  g.items = (g.items || []).map(i => {
                      if (state.originalStates.has(i.id)) {
                          const original = state.originalStates.get(i.id);
                          return {
                              ...i,
                              status: original.status,
                              note: original.note
                          };
                      }

                      let newStatus = "pending";
                      if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(i.title)) {
                          newStatus = "na";
                      }

                      return { ...i, status: newStatus };
                  });
                  save();
                  render();
              });

              const delGroupBtn = document.createElement("button");
              delGroupBtn.className = "btn-ghost";
              delGroupBtn.textContent = "L√∂schen";
              delGroupBtn.addEventListener("click", () => {
                  if (!confirm(`Pr√ºfpunkt "${g.title}" wirklich l√∂schen?`)) return;
                  g.items.forEach(item => {
                      state.originalStates.delete(item.id);
                  });
                  state.groups = state.groups.filter(x => x.id !== g.id);
                  save();
                  render();
              });

              headerActions.appendChild(setAllOkBtn);
              headerActions.appendChild(setAllNokBtn);
              headerActions.appendChild(resetAllBtn);
              headerActions.appendChild(delGroupBtn);

              header.appendChild(titleRow);
              header.appendChild(headerActions);
              groupWrap.appendChild(header);

              if (!g.collapsed) {
                  const body = document.createElement("div");
                  body.className = "groupBody";

                  const addRow = document.createElement("div");
                  addRow.className = "row";

                  const subInput = document.createElement("input");
                  subInput.type = "text";
                  subInput.placeholder = `Sub-Check f√ºr "${g.title}" (z.B. Status)`;

                  const addSubBtn = document.createElement("button");
                  addSubBtn.className = "btn-primary";
                  addSubBtn.textContent = "Sub-Check hinzuf√ºgen";
                  addSubBtn.type = "button";

                  function addSub() {
                      const t = subInput.value.trim();
                      if (!t) return;
                      let status = "pending";

                      if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(t)) {
                          status = "na";
                      }

                      const newItem = {
                          id: uid(),
                          title: t,
                          status: status,
                          note: ""
                      };

                      state.originalStates.set(newItem.id, {
                          status: status,
                          note: ""
                      });

                      g.items = g.items || [];
                      g.items.push(newItem);
                      subInput.value = "";
                      save();
                      render();
                  }

                  addSubBtn.addEventListener("click", addSub);
                  subInput.addEventListener("keydown", (e) => {
                      if (e.key === "Enter") addSub();
                  });

                  addRow.appendChild(subInput);
                  addRow.appendChild(addSubBtn);

                  const ul = document.createElement("ul");
                  ul.className = "items";

                  const items = (g.items || []).map(it => ({
                      note: "",
                      status: "pending",
                      ...it
                  }));
                  g.items = items;

                  if (items.length === 0) {
                      const empty = document.createElement("div");
                      empty.className = "muted";
                      empty.textContent = "Noch keine Sub-Checks. F√ºge oben einen hinzu.";
                      body.appendChild(addRow);
                      body.appendChild(empty);
                  } else {
                      for (const item of items) {
                          const li = document.createElement("li");
                          li.className = "item";
                          if (item.status === "ok") li.classList.add("done");

                          if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(item.title)) {
                              li.classList.add("auto-na");
                              li.title = "Automatisch N/A im Basisinspektion-Modus (keine Messungen)";
                          }

                          const top = document.createElement("div");
                          top.className = "itemTop";

                          const radioContainer = document.createElement("div");
                          radioContainer.className = "sub-check-container";

                          const subCheck = document.createElement("div");
                          subCheck.className = "sub-check";

                          const titleContainer = document.createElement("div");
                          titleContainer.className = "itemTitle";
                          
                          const titleText = document.createElement("span");
                          titleText.className = "itemTitle-text";
                          titleText.textContent = item.title;
                          
                          const infoIcon = document.createElement("span");
                          infoIcon.className = "info-icon";
                          infoIcon.textContent = "i";
                          infoIcon.title = "Informationen zu diesem Sub-Check";
                          infoIcon.dataset.subcheck = item.title;
                          infoIcon.addEventListener("click", (e) => {
                              e.stopPropagation();
                              showSubcheckInfo(item.title);
                          });
                          
                          titleContainer.appendChild(titleText);
                          titleContainer.appendChild(infoIcon);

                          const isAutoNA = state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(item.title);

                          const okOption = createRadioOption("ok", item.id, "OK", item.status === "ok", isAutoNA);
                          const nokOption = createRadioOption("nok", item.id, "Nicht OK", item.status === "nok", isAutoNA);
                          const naOption = createRadioOption("na", item.id, "N/A", item.status === "na", isAutoNA);

                          const statusBadge = document.createElement("span");
                          statusBadge.className = `sub-check-status status-${item.status || "pending"}`;
                          updateStatusBadge(statusBadge, item.status);

                          subCheck.appendChild(titleContainer);
                          subCheck.appendChild(okOption);
                          subCheck.appendChild(nokOption);
                          subCheck.appendChild(naOption);
                          subCheck.appendChild(statusBadge);

                          if (isAutoNA) {
                              const autoBadge = document.createElement("span");
                              autoBadge.className = "sub-check-status";
                              autoBadge.style.background = "#e5e7eb";
                              autoBadge.style.color = "#4b5563";
                              autoBadge.style.marginLeft = "5px";
                              autoBadge.textContent = "Auto";
                              autoBadge.title = "Automatisch N/A im Basisinspektion-Modus";
                              subCheck.appendChild(autoBadge);
                          }

                          radioContainer.appendChild(subCheck);

                          if (!isAutoNA) {
                              okOption.addEventListener('click', () => {
                                  updateSubStatus(g.id, item.id, "ok");
                              });
                              nokOption.addEventListener('click', () => {
                                  updateSubStatus(g.id, item.id, "nok");
                              });
                              naOption.addEventListener('click', () => {
                                  updateSubStatus(g.id, item.id, "na");
                              });
                          } else {
                              okOption.style.opacity = "0.6";
                              okOption.style.cursor = "not-allowed";
                              nokOption.style.opacity = "0.6";
                              nokOption.style.cursor = "not-allowed";
                              naOption.style.opacity = "0.6";
                              naOption.style.cursor = "not-allowed";
                              naOption.classList.add('selected');
                          }

                          const noteBox = document.createElement("div");
                          noteBox.className = "noteBox";

                          const noteLabel = document.createElement("div");
                          noteLabel.className = "noteLabel";
                          noteLabel.textContent = "Notizen / Auff√§lligkeiten:";

                          const note = document.createElement("textarea");
                          note.placeholder = "z.B. Auff√§lligkeit, Messwert, Hinweis‚Ä¶";
                          note.value = item.note || "";
                          note.addEventListener("input", () => updateNote(g.id, item.id, note.value));

                          noteBox.appendChild(noteLabel);
                          noteBox.appendChild(note);

                          const del = document.createElement("button");
                          del.className = "btn-ghost";
                          del.textContent = "L√∂schen";
                          del.type = "button";
                          del.style.marginTop = "8px";
                          del.addEventListener("click", () => removeSub(g.id, item.id));

                          top.appendChild(radioContainer);
                          li.appendChild(top);
                          li.appendChild(noteBox);
                          li.appendChild(del);

                          ul.appendChild(li);
                      }
                      body.appendChild(addRow);
                      body.appendChild(ul);
                  }
                  groupWrap.appendChild(body);
              } else {
                  const collapsedInfo = document.createElement("div");
                  collapsedInfo.className = "groupBody";
                  collapsedInfo.style.padding = "12px";
                  collapsedInfo.style.fontSize = "12px";
                  collapsedInfo.style.color = "var(--muted)";
                  collapsedInfo.textContent = `${g.items.length} Sub-Checks (geklappt)`;
                  groupWrap.appendChild(collapsedInfo);
              }

              elGroups.appendChild(groupWrap);
          }
      }

      function createRadioOption(value, itemId, label, checked, disabled = false) {
          const option = document.createElement("div");
          option.className = `option ${value} ${checked ? 'selected' : ''}`;
          if (disabled) {
              option.style.opacity = "0.6";
              option.style.cursor = "not-allowed";
          }

          const span = document.createElement("span");
          span.textContent = label;

          option.appendChild(span);

          const input = document.createElement("input");
          input.type = "radio";
          input.name = `subcheck_${itemId}`;
          input.value = value;
          input.checked = checked;
          input.style.display = "none";

          option.appendChild(input);

          return option;
      }

      function updateStatusBadge(badge, status) {
          let text = "Ausstehend";
          switch(status) {
              case "ok": text = "OK"; break;
              case "nok": text = "Nicht OK"; break;
              case "na": text = "N/A"; break;
          }
          badge.textContent = text;
          badge.className = `sub-check-status status-${status || "pending"}`;
      }

      function addGroup(title) {
          const t = title.trim();
          if (!t) return;
          state.groups.push({
              id: uid(),
              title: t,
              collapsed: false,
              items: []
          });
          save();
          render();
      }

      function updateSubStatus(groupId, itemId, status) {
          state.groups = state.groups.map(g => {
              if (g.id !== groupId) return g;
              return {
                  ...g,
                  items: (g.items || []).map(i =>
                      i.id === itemId ? { ...i, status } : i
                  )
              };
          });

          const item = state.groups.find(g => g.id === groupId)?.items.find(i => i.id === itemId);
          if (item && !state.originalStates.has(itemId)) {
              state.originalStates.set(itemId, {
                  status: status,
                  note: item.note || ""
              });
          }

          save();
          render();
      }

      function updateNote(groupId, itemId, note) {
          state.groups = state.groups.map(g => {
              if (g.id !== groupId) return g;
              return { ...g, items: (g.items || []).map(i => i.id === itemId ? { ...i, note } : i) };
          });

          const item = state.groups.find(g => g.id === groupId)?.items.find(i => i.id === itemId);
          if (item && !state.originalStates.has(itemId)) {
              state.originalStates.set(itemId, {
                  status: item.status,
                  note: note
              });
          }

          save();
      }

      function removeSub(groupId, itemId) {
          state.originalStates.delete(itemId);

          state.groups = state.groups.map(g => {
              if (g.id !== groupId) return g;
              return { ...g, items: (g.items || []).filter(i => i.id !== itemId) };
          });
          save();
          render();
      }

      function setAllOk() {
          state.groups = state.groups.map(g => ({
              ...g,
              items: (g.items || []).map(i => {
                  if (!state.originalStates.has(i.id)) {
                      state.originalStates.set(i.id, {
                          status: i.status,
                          note: i.note || ""
                      });
                  }

                  if (state.mode === "basic" && BASIC_MODE_NA_ITEMS.includes(i.title)) {
                      return { ...i, status: "na" };
                  }
                  return { ...i, status: "ok" };
              })
          }));
          save();
          render();
      }

      function resetAll() {
          if (!confirm("Wirklich alles l√∂schen?")) return;
          state = {
              anlage: state.anlage,
              tunnel: state.tunnel,
              name: "",
              mode: "basic",
              groups: [],
              useRadioMode: true,
              originalStates: new Map()
          };
          elListName.value = "";
          elModeRadios.forEach(r => r.checked = (r.value === state.mode));
          save();
          render();
      }

      function setAllCollapsed(collapsed) {
          state.groups = state.groups.map(g => ({ ...g, collapsed }));
          save();
          render();
      }

      function loadTemplate() {
          const template = getFunksystemeTemplate();
          if (state.groups.length > 0) {
              if (!confirm("Vorlage laden und aktuelle Pr√ºfpunkte ersetzen?")) return;
          }
          state.groups = template.groups;
          if (!state.name) state.name = template.name;
          elListName.value = state.name || "";

          state.groups.forEach(g => g.collapsed = false);

          saveOriginalStates();

          if (state.mode === "basic") {
              applyBasicModeNA();
          }
          
          save();
          render();
      }

      function getFunksystemeTemplate() {
          const mkGroup = (title, items) => ({
              id: uid(),
              title,
              collapsed: false,
              items: items.map(t => ({
                  id: uid(),
                  title: t,
                  status: "pending",
                  note: ""
              }))
          });

          return {
              name: "Funksysteme ‚Äì LCM",
              groups: [
                  mkGroup("UKW", ["UKW-Status"]),
                  mkGroup("DAB", ["DAB-Status","DAB Ensembles","DAB Reserve","DAB RX-Pegel Donor","DAB C/N"]),
                  mkGroup("Einsprechanlage (ESA)", ["ESA Status","ESA Funktion","ESA Qualit√§t","ESA RadioText"]),
                  mkGroup("Analogfunk", ["Analogfunk Status"]),
                  mkGroup("PYC", ["PYC Status","Repeater Funktion"]),
                  mkGroup("Kabelanlage ‚Äì Fahrbahnen (FB)", [
                      "SK FB Status","SK FB Stecker Status","SK FB RX-Pegel UKW","SK FB RX-Pegel DAB","SK FB RX-Pegel PYC",
                      "SK FB TX-Pegel UKW","SK FB TX-Pegel DAB","SK FB TX-Pegel PYC",
                      "SK FB RL-Messung Status","SK FB RL-Messung","SK FB PIM-Messung Status","SK FB PIM-Messung","SK FB PIM Messung neu"
                  ]),
                  mkGroup("WELK & SISTO", [
                      "SK WELK Status","SK WELK PYC","SK WELK TX-Pegel PYC","SK WELK RX-Pegel PYC","SK WELK PP Status","SK WELK PP Frequenzen","SK WELK RX-Pegel PP",
                      "SK SISTO Status","SK SISTO PYC","SK SISTO TX-Pegel PYC","SK SISTO RX-Pegel PYC","SK SISTO PP Status","SK SISTO PP Frequenzen","SK SISTO RX-Pegel PP"
                  ]),
                  mkGroup("Tunnelzentrale (TZ) ‚Äì Inhouseversorgung (IHV)", [
                      "IHV TZ Status","IHV TZ Status PYC","IHV TZ Status PP","IHV TZ Status PP Frequenz","IHV TZ Status RX-Pegel PP"
                  ]),
                  mkGroup("Allgemein", [
                      "Technologiebeurteilung Ersatzteilproblematik","Eigentumsverh√§ltnis","Physikalische Infrastruktur","Normen","SPS",
                      "Repeater & SPS Konfiguration","FO Status","TPS Status"
                  ])
              ]
          };
      }

      // ====== EXPORT FUNCTIONS ======
      function generateExportDocument() {
          const now = new Date();
          const dateStr = now.toLocaleString('de-DE');
          const { ok, nok, na, total } = computeStats();
          
          const esc = (s) => String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
          
          let sections = '';
          state.groups.forEach((g, idx) => {
              let itemsHTML = '';
              (g.items || []).forEach(item => {
                  let statusSymbol = "‚óã";
                  let statusColor = "#6b7280";
                  switch(item.status) {
                      case "ok": statusSymbol = "‚úÖ"; statusColor = "#10b981"; break;
                      case "nok": statusSymbol = "‚ùå"; statusColor = "#ef4444"; break;
                      case "na": statusSymbol = "‚ûñ"; statusColor = "#6b7280"; break;
                  }
                  
                  const isAutoNA = BASIC_MODE_NA_ITEMS.includes(item.title) && state.mode === "basic";
                  const autoText = isAutoNA ? " (Auto N/A)" : "";
                  
                  itemsHTML += `
                      <tr>
                          <td class="colMark" style="color:${statusColor}; font-size:16px;">${statusSymbol}</td>
                          <td class="colItem">${esc(item.title)}${isAutoNA ? '<br/><small style="color:#6b7280;">Automatisch N/A im Basis-Modus</small>' : ''}</td>
                          <td class="colNote">${esc(statusLabel(item.status))}${autoText}</td>
                          <td class="colNote">${esc(item.note || '').replace(/\n/g, '<br/>')}</td>
                      </tr>`;
              });
              
              sections += `
                  <div class="section">
                      <div class="secTitle">${idx+1}. ${esc(g.title)}</div>
                      <table class="tbl">
                          <thead>
                              <tr>
                                  <th class="colMark">Status</th>
                                  <th class="colItem">Pr√ºfpunkt / Parameter</th>
                                  <th class="colNote">Bewertung</th>
                                  <th class="colNote">Notizen / Auff√§lligkeiten</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${itemsHTML || '<tr><td colspan="4" class="empty">Keine Sub-Checks</td></tr>'}
                          </tbody>
                      </table>
                  </div>`;
          });

          return `
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>${esc(state.name || "Dokument")}</title>
<style>
  :root{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Calibri, sans-serif; color:#111; }
  @page { 
      size: A4; 
      margin: 18mm 16mm 18mm 16mm;
      @bottom-right {
          content: "Seite " counter(page) " von " counter(pages);
          font-size: 10pt;
          color: #666;
      }
  }
  body{ margin: 0; }
  .page{ padding: 0; }
  .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 14px;
      padding-bottom: 10px;
      border-bottom: 2px solid #bfe3d6;
  }
  .boess{
      font-size: 34px;
      font-weight: 650;
      color:#07694D;
      letter-spacing: 3px;
      line-height: 1;
  }
  .metaRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      color:#111;
      font-size: 12px;
  }
  .chip{
      border: 1px solid #d7dbe7;
      border-radius: 999px;
      padding: 6px 10px;
      background: #fff;
  }
  .status-summary {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      font-size: 12px;
  }
  .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
  }
  .status-ok { color: #10b981; }
  .status-nok { color: #ef4444; }
  .status-na { color: #6b7280; }
  .mode-info {
      background: #f0f9ff;
      border: 1px solid #bfe3d6;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
  }
  h1{ margin: 14px 0 6px 0; font-size: 16px; }
  .sub{ margin: 0 0 14px 0; color:#6b7280; font-size: 12px; }
  .section{ margin: 12px 0 14px 0; }
  .secTitle{ font-weight: 900; font-size: 13px; margin: 0 0 8px 0; }
  .tbl{ width: 100%; border-collapse: collapse; font-size: 11px; }
  .tbl th, .tbl td{ border: 1px solid #d7dbe7; padding: 6px 7px; vertical-align: top; }
  .tbl th{ background: #eef7f3; text-align: left; }
  .colMark{ width: 40px; text-align: center; font-weight: 900; }
  .colItem{ width: 35%; }
  .colNote{ width: 25%; }
  .empty{ color:#6b7280; }
  .footer{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      color:#6b7280;
      font-size: 10px;
      border-top: 1px solid #d7dbe7;
      padding-top: 8px;
  }
</style>
</head>
<body>
  <div class="page">
      <div class="top">
          <div></div>
          <div class="boess">Boess</div>
      </div>

      <h1>Checklist Boess (Live Cycle Management)</h1>
      <div class="sub">${esc(state.name || "")}</div>

      <div class="metaRow">
          <div class="chip"><b>Teilanlage:</b> ${esc(state.anlage)}</div>
          <div class="chip"><b>Tunnel:</b> ${esc(state.tunnel)}</div>
          <div class="chip"><b>Inspektion:</b> ${esc(modeLabel(state.mode))}</div>
          <div class="chip"><b>Datum:</b> ${esc(dateStr)}</div>
          <div class="chip"><b>Status:</b> ${ok}‚úì ${nok}‚úó ${na}‚Äì / ${total}</div>
      </div>

      ${state.mode === "basic" ? `<div class="mode-info">
          <b>Basisinspektion:</b> Visuelle Pr√ºfung ohne Messungen. Messpunkte sind automatisch als N/A markiert.
      </div>` : ''}

      <div class="status-summary">
          <div class="status-item status-ok">‚úÖ OK: ${ok}</div>
          <div class="status-item status-nok">‚ùå Nicht OK: ${nok}</div>
          <div class="status-item status-na">‚ûñ N/A: ${na}</div>
      </div>

      ${sections || '<div class="empty">Keine Daten</div>'}

      <div class="footer">
          <div>BOESS LCM Checklist Tool v${VERSION} (Teilanlage: ${state.anlage})</div>
          <div>${esc(dateStr)}</div>
      </div>
  </div>
</body>
</html>`;
      }

      // ========================================
      // EXPORTAR PDF - VERSI√ìN COMPATIBLE CON iOS/iPadOS
      // ========================================
      function exportPdf() {
          try {
              const content = generateExportDocument();
              
              // Detectar iOS/iPadOS
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
              
              if (isIOS) {
                  // M√©todo iOS: Abrir en nueva pesta√±a
                  const newWindow = window.open();
                  if (!newWindow) {
                      alert('Popup-Blocker verhindert PDF-Generierung. Bitte Popups f√ºr diese Seite erlauben.');
                      return;
                  }
                  
                  newWindow.document.write(content);
                  newWindow.document.close();
                  
                  // Instrucciones para usuario de iPad
                  setTimeout(() => {
                      alert('EN iPAD:\n\n' +
                            '1. Tippen Sie auf "Teilen" (Quadrat mit Pfeil nach oben)\n' +
                            '2. Scrollen Sie nach unten\n' +
                            '3. Tippen Sie auf "Zu Dateien"\n' +
                            '4. W√§hlen Sie Speicherort und tippen Sie "Speichern"\n\n' +
                            'Das PDF wird in der App "Dateien" gespeichert.');
                  }, 1000);
                  
              } else {
                  // M√©todo original para otros dispositivos
                  const printWindow = window.open('', '_blank', 'width=800,height=600');
                  
                  if (!printWindow) {
                      alert('Popup-Blocker verhindert PDF-Generierung. Bitte Popups f√ºr diese Seite erlauben.');
                      return;
                  }
                  
                  printWindow.document.write(content);
                  printWindow.document.close();
                  
                  printWindow.onload = function() {
                      setTimeout(() => {
                          printWindow.print();
                          setTimeout(() => {
                              if (!printWindow.closed) {
                                  printWindow.close();
                              }
                          }, 1000);
                      }, 500);
                  };
              }
              
          } catch (error) {
              console.error('PDF export error:', error);
              alert('Fehler beim Erstellen des PDF: ' + error.message);
              
              // Fallback: Descargar como HTML
              const content = generateExportDocument();
              const name = fileSafeName(`LCM_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
              downloadBlob(new Blob([content], { type: 'text/html' }), `${name}.html`);
          }
      }

      // ========================================
      // EXPORTAR WORD - Con fallback mejorado
      // ========================================
      async function exportWordDoc() {
          try {
              if (typeof docx === 'undefined') {
                  const usePdf = confirm(
                      "Word-Export ben√∂tigt Internetverbindung.\n" +
                      "Die docx-Bibliothek ist nicht verf√ºgbar.\n\n" +
                      "M√∂chten Sie stattdessen:\n" +
                      "‚Ä¢ Ein PDF erstellen (OK)\n" +
                      "‚Ä¢ Text-Datei exportieren (Abbrechen)\n\n" +
                      "F√ºr volle Funktionalit√§t:\n" +
                      "1. Mit Internet verbinden, oder\n" +
                      "2. Lokalen Server verwenden"
                  );
                  
                  if (usePdf) {
                      exportPdf();
                  } else {
                      exportSimpleText();
                  }
                  return;
              }

              const { 
                  Document, Paragraph, TextRun, Table, TableRow, TableCell, 
                  WidthType, AlignmentType, HeadingLevel, BorderStyle, Packer
              } = docx;
              
              const now = new Date();
              const footerDate = formatDateForFooter(now);
              const { ok, nok, na, total } = computeStats();

              const originalText = elExportWordBtn.textContent;
              elExportWordBtn.innerHTML = '<span class="loading">‚è≥</span> Erstelle Word...';
              elExportWordBtn.disabled = true;

              const doc = new Document({
                  sections: [{
                      properties: {
                          page: {
                              margin: {
                                  top: 720,
                                  right: 720,
                                  bottom: 720,
                                  left: 720
                              }
                          }
                      },
                      children: [
                          new Paragraph({
                              text: "Checklist Boess (Live Cycle Management)",
                              heading: HeadingLevel.HEADING_1,
                              alignment: AlignmentType.CENTER,
                              spacing: { before: 400, after: 200 }
                          }),
                          
                          new Paragraph({
                              text: state.name || "",
                              alignment: AlignmentType.CENTER,
                              spacing: { after: 300 }
                          }),
                          
                          new Paragraph({
                              text: `Teilanlage: ${state.anlage}`,
                              spacing: { after: 100 }
                          }),
                          
                          new Paragraph({
                              text: `Tunnel: ${state.tunnel}`,
                              spacing: { after: 100 }
                          }),
                          
                          new Paragraph({
                              text: `Inspektion: ${modeLabel(state.mode)}`,
                              spacing: { after: 100 }
                          }),
                          
                          new Paragraph({
                              text: `Datum: ${footerDate}`,
                              spacing: { after: 100 }
                          }),
                          
                          new Paragraph({
                              text: `Status: ${ok}‚úì ${nok}‚úó ${na}‚Äì / ${total}`,
                              spacing: { after: 300 }
                          }),
                          
                          ...(state.mode === "basic" ? [new Paragraph({
                              text: "Basisinspektion: Visuelle Pr√ºfung ohne Messungen. Messpunkte sind automatisch als N/A markiert.",
                              spacing: { before: 200, after: 200 }
                          })] : []),
                          
                          new Paragraph({
                              children: [
                                  new TextRun({
                                      text: `‚úì OK: ${ok}`,
                                      color: "10B981",
                                      bold: true
                                  }),
                                  new TextRun({
                                      text: "   ",
                                  }),
                                  new TextRun({
                                      text: `‚úó Nicht OK: ${nok}`,
                                      color: "EF4444",
                                      bold: true
                                  }),
                                  new TextRun({
                                      text: "   ",
                                  }),
                                  new TextRun({
                                      text: `‚Äì N/A: ${na}`,
                                      color: "6B7280",
                                      bold: true
                                  })
                              ],
                              spacing: { before: 200, after: 300 },
                              alignment: AlignmentType.LEFT
                          }),

                          ...state.groups.flatMap((group, groupIndex) => {
                              const sectionElements = [];
                              
                              sectionElements.push(new Paragraph({
                                  text: `${groupIndex + 1}. ${group.title}`,
                                  heading: HeadingLevel.HEADING_2,
                                  spacing: { before: 300, after: 150 },
                                  border: {
                                      bottom: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" }
                                  }
                              }));
                              
                              if (group.items && group.items.length > 0) {
                                  const tableRows = [];
                                  
                                  tableRows.push(new TableRow({
                                      children: [
                                          new TableCell({
                                              children: [new Paragraph({
                                                  text: "Status",
                                                  bold: true,
                                                  alignment: AlignmentType.CENTER
                                              })],
                                              shading: { fill: "F0F0F0" },
                                              width: { size: 15, type: WidthType.PERCENTAGE }
                                          }),
                                          new TableCell({
                                              children: [new Paragraph({
                                                  text: "Pr√ºfpunkt",
                                                  bold: true
                                              })],
                                              shading: { fill: "F0F0F0" },
                                              width: { size: 40, type: WidthType.PERCENTAGE }
                                          }),
                                          new TableCell({
                                              children: [new Paragraph({
                                                  text: "Bewertung",
                                                  bold: true
                                              })],
                                              shading: { fill: "F0F0F0" },
                                              width: { size: 25, type: WidthType.PERCENTAGE }
                                          }),
                                          new TableCell({
                                              children: [new Paragraph({
                                                  text: "Notizen",
                                                  bold: true
                                              })],
                                              shading: { fill: "F0F0F0" },
                                              width: { size: 40, type: WidthType.PERCENTAGE }
                                          })
                                      ]
                                  }));
                                  
                                  group.items.forEach(item => {
                                      let statusSymbol = "‚óã";
                                      switch(item.status) {
                                          case "ok": statusSymbol = "‚úì"; break;
                                          case "nok": statusSymbol = "‚úó"; break;
                                          case "na": statusSymbol = "‚Äì"; break;
                                      }
                                      
                                      const isAutoNA = BASIC_MODE_NA_ITEMS.includes(item.title) && state.mode === "basic";
                                      const evaluation = statusLabel(item.status) + (isAutoNA ? " (Auto N/A)" : "");
                                      
                                      tableRows.push(new TableRow({
                                          children: [
                                              new TableCell({
                                                  children: [new Paragraph({
                                                      text: statusSymbol,
                                                      alignment: AlignmentType.CENTER
                                                  })]
                                              }),
                                              new TableCell({
                                                  children: [new Paragraph(item.title)]
                                              }),
                                              new TableCell({
                                                  children: [new Paragraph(evaluation)]
                                              }),
                                              new TableCell({
                                                  children: [new Paragraph(item.note || "")]
                                              })
                                          ]
                                      }));
                                  });
                                  
                                  sectionElements.push(new Table({
                                      rows: tableRows,
                                      width: { size: 100, type: WidthType.PERCENTAGE },
                                      alignment: AlignmentType.CENTER
                                  }));
                              } else {
                                  sectionElements.push(new Paragraph({
                                      text: "Keine Sub-Checks",
                                      italics: true,
                                      spacing: { before: 100 }
                                  }));
                              }
                              
                              sectionElements.push(new Paragraph({
                                  text: "",
                                  spacing: { before: 200 }
                              }));
                              
                              return sectionElements;
                          }),
                          
                          new Paragraph({
                              text: `BOESS Checklist System v${VERSION} (Teilanlage: ${state.anlage}) ¬∑ ${footerDate}`,
                              alignment: AlignmentType.CENTER,
                              spacing: { before: 400 },
                              border: {
                                  top: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" }
                              }
                          })
                      ]
                  }]
              });

              const blob = await Packer.toBlob(doc);
              const name = fileSafeName(`LCM_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
              downloadBlob(blob, `${name}.docx`);
              
              elExportWordBtn.textContent = originalText;
              elExportWordBtn.disabled = false;
              
          } catch (error) {
              console.error('Word export error:', error);
              
              const fallback = confirm(
                  "Fehler beim Erstellen der Word-Datei.\n" +
                  "M√∂chten Sie stattdessen ein PDF erstellen?"
              );
              
              if (fallback) {
                  exportPdf();
              } else {
                  exportSimpleText();
              }
              
              elExportWordBtn.textContent = "Als Word (.docx) exportieren";
              elExportWordBtn.disabled = false;
          }
      }

      // ========================================
      // EXPORTAR EXCEL - Con fallback mejorado
      // ========================================
      function exportExcel() {
          try {
              if (typeof XLSX === 'undefined') {
                  const useCsv = confirm(
                      "Excel-Export ben√∂tigt Internetverbindung.\n" +
                      "Die xlsx-Bibliothek ist nicht verf√ºgbar.\n\n" +
                      "M√∂chten Sie stattdessen CSV exportieren?\n\n" +
                      "F√ºr volle Funktionalit√§t:\n" +
                      "1. Mit Internet verbinden, oder\n" +
                      "2. Lokalen Server verwenden"
                  );
                  
                  if (useCsv) {
                      exportCsv();
                  }
                  return;
              }

              const now = new Date();
              const footerDate = formatDateForFooter(now);
              const { ok, nok, na, total } = computeStats();

              const originalText = elExportExcelBtn.textContent;
              elExportExcelBtn.innerHTML = '<span class="loading">‚è≥</span> Erstelle Excel...';
              elExportExcelBtn.disabled = true;

              const wb = XLSX.utils.book_new();
              wb.Props = {
                  Title: "BOESS Checklist",
                  Subject: "Live Cycle Management",
                  Author: "BOESS Checklist System",
                  CreatedDate: new Date()
              };

              const wsData = [];
              
              wsData.push(["Checklist Boess (Live Cycle Management)"]);
              wsData.push([state.name || ""]);
              wsData.push([]);
              
              wsData.push(["Teilanlage:", state.anlage]);
              wsData.push(["Tunnel:", state.tunnel]);
              wsData.push(["Inspektion:", modeLabel(state.mode)]);
              wsData.push(["Datum:", footerDate]);
              wsData.push(["Status:", `${ok}‚úì ${nok}‚úó ${na}‚Äì / ${total}`]);
              wsData.push([]);
              
              if (state.mode === "basic") {
                  wsData.push(["Basisinspektion:", "Visuelle Pr√ºfung ohne Messungen. Messpunkte sind automatisch als N/A markiert."]);
                  wsData.push([]);
              }
              
              wsData.push(["Zusammenfassung:"]);
              wsData.push(["‚úì OK:", ok]);
              wsData.push(["‚úó Nicht OK:", nok]);
              wsData.push(["‚Äì N/A:", na]);
              wsData.push(["Gesamt:", total]);
              wsData.push([]);
              
              state.groups.forEach((group, groupIndex) => {
                  wsData.push([`${groupIndex + 1}. ${group.title}`]);
                  
                  wsData.push(["Status", "Pr√ºfpunkt / Parameter", "Bewertung", "Notizen / Auff√§lligkeiten", "Auto N/A"]);
                  
                  if (group.items && group.items.length > 0) {
                      group.items.forEach(item => {
                          let statusSymbol = "‚óã";
                          switch(item.status) {
                              case "ok": statusSymbol = "‚úì"; break;
                              case "nok": statusSymbol = "‚úó"; break;
                              case "na": statusSymbol = "‚Äì"; break;
                          }
                          
                          const isAutoNA = BASIC_MODE_NA_ITEMS.includes(item.title) && state.mode === "basic";
                          const evaluation = statusLabel(item.status);
                          
                          wsData.push([
                              statusSymbol,
                              item.title,
                              evaluation,
                              item.note || "",
                              isAutoNA ? "Ja" : "Nein"
                          ]);
                      });
                  } else {
                      wsData.push(["", "Keine Sub-Checks", "", "", ""]);
                  }
                  
                  wsData.push([]);
                  wsData.push([]);
              });
              
              wsData.push([]);
              wsData.push([`BOESS Checklist System v${VERSION} (Teilanlage: ${state.anlage}) ¬∑ ${footerDate}`]);
              
              const ws = XLSX.utils.aoa_to_sheet(wsData);
              
              const colWidths = [
                  { wch: 8 },
                  { wch: 40 },
                  { wch: 15 },
                  { wch: 50 },
                  { wch: 10 }
              ];
              ws['!cols'] = colWidths;
              
              XLSX.utils.book_append_sheet(wb, ws, "Checklist");
              
              const name = fileSafeName(`LCM_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
              XLSX.writeFile(wb, `${name}.xlsx`);
              
              elExportExcelBtn.textContent = originalText;
              elExportExcelBtn.disabled = false;
              
          } catch (error) {
              console.error('Excel export error:', error);
              
              const fallback = confirm(
                  "Fehler beim Erstellen der Excel-Datei.\n" +
                  "M√∂chten Sie stattdessen CSV exportieren?"
              );
              
              if (fallback) {
                  exportCsv();
              }
              
              elExportExcelBtn.textContent = "Als Excel (.xlsx) exportieren";
              elExportExcelBtn.disabled = false;
          }
      }

      // ========================================
      // FUNCI√ìN DE FALLBACK: Exportar texto simple
      // ========================================
      function exportSimpleText() {
          const now = new Date();
          const dateStr = formatDateForFooter(now);
          const { ok, nok, na, total } = computeStats();
          
          let content = `BOESS CHECKLIST - Live Cycle Management\n`;
          content += `========================================\n\n`;
          content += `Teilanlage: ${state.anlage}\n`;
          content += `Tunnel: ${state.tunnel}\n`;
          content += `Listenname: ${state.name || ""}\n`;
          content += `Inspektion: ${modeLabel(state.mode)}\n`;
          content += `Datum: ${dateStr}\n`;
          content += `Status: ${ok}‚úì ${nok}‚úó ${na}‚Äì / ${total}\n\n`;
          
          if (state.mode === "basic") {
              content += `Basisinspektion: Visuelle Pr√ºfung ohne Messungen.\n`;
              content += `Messpunkte sind automatisch als N/A markiert.\n\n`;
          }
          
          content += `ZUSAMMENFASSUNG\n`;
          content += `‚úì OK: ${ok}\n`;
          content += `‚úó Nicht OK: ${nok}\n`;
          content += `‚Äì N/A: ${na}\n`;
          content += `Gesamt: ${total}\n\n`;
          
          content += `PR√úFPUNKTE\n`;
          content += `==========\n\n`;
          
          state.groups.forEach((group, groupIndex) => {
              content += `${groupIndex + 1}. ${group.title}\n`;
              content += `${'='.repeat(40)}\n`;
              
              if (group.items && group.items.length > 0) {
                  group.items.forEach(item => {
                      let statusSymbol = "[ ]";
                      switch(item.status) {
                          case "ok": statusSymbol = "[‚úì]"; break;
                          case "nok": statusSymbol = "[‚úó]"; break;
                          case "na": statusSymbol = "[‚Äì]"; break;
                      }
                      
                      const isAutoNA = BASIC_MODE_NA_ITEMS.includes(item.title) && state.mode === "basic";
                      const autoText = isAutoNA ? " (Auto N/A)" : "";
                      
                      content += `${statusSymbol} ${item.title}${autoText}\n`;
                      if (item.note) {
                          content += `    Notiz: ${item.note}\n`;
                      }
                      content += '\n';
                  });
              } else {
                  content += `Keine Sub-Checks\n\n`;
              }
              content += '\n';
          });
          
          content += `\n\n`;
          content += `Exportiert mit BOESS Checklist System v${VERSION}\n`;
          content += `Teilanlage: ${state.anlage} ¬∑ ${dateStr}\n`;
          
          const name = fileSafeName(`TEXT_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
          downloadBlob(new Blob([content], { type: 'text/plain;charset=utf-8' }), `${name}.txt`);
      }

      function exportCsv() {
          const now = new Date();
          const dateStr = formatDateForFooter(now);
          const rows = [];
          rows.push(["Teilanlage","Tunnel","Listenname","Inspektionsmodus","Pr√ºfpunkt","Sub-Check","Status","Notiz","Automatisch N/A","Exportzeit"]);

          for (const g of state.groups){
              for (const i of (g.items || [])){
                  const isAutoNA = BASIC_MODE_NA_ITEMS.includes(i.title) && state.mode === "basic";
                  rows.push([
                      state.anlage,
                      state.tunnel,
                      state.name || "",
                      modeLabel(state.mode),
                      g.title || "",
                      i.title || "",
                      statusLabel(i.status),
                      (i.note || "").replace(/\n/g, " ").replace(/\r/g, ""),
                      isAutoNA ? "Ja" : "Nein",
                      dateStr
                  ]);
              }
          }

          const csv = rows.map(r => r.map(v => {
              const s = String(v ?? "");
              if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
              return s;
          }).join(",")).join("\n");

          const name = fileSafeName(`LCM_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
          downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), `${name}.csv`);
      }

      function exportJson(){
          const stateToSave = {
              ...state,
              originalStates: Object.fromEntries(state.originalStates)
          };

          const name = fileSafeName(`Backup_${state.anlage}_${state.tunnel}_${state.name || "Checklist"}`);
          downloadBlob(new Blob([JSON.stringify(stateToSave, null, 2)], {type:"application/json"}), `${name}.json`);
      }

      function importJson(){
          const inp = document.createElement("input");
          inp.type = "file";
          inp.accept = "application/json";
          inp.addEventListener("change", async () => {
              const file = inp.files && inp.files[0];
              if (!file) return;
              try{
                  const txt = await file.text();
                  const data = JSON.parse(txt);
                  if (!data || typeof data !== "object") throw new Error("Ung√ºltige Datei");
                  if (!Array.isArray(data.groups)) data.groups = [];
                  if (data.mode !== "basic" && data.mode !== "detailed") data.mode = "basic";
                  if (typeof data.useRadioMode !== "boolean") data.useRadioMode = true;

                  if (data.originalStates && !(data.originalStates instanceof Map)) {
                      data.originalStates = new Map(Object.entries(data.originalStates));
                  } else if (!data.originalStates) {
                      data.originalStates = new Map();
                  }

                  data.anlage = state.anlage;
                  data.tunnel = state.tunnel;
                  state = data;
                  elListName.value = state.name || "";
                  elModeRadios.forEach(r => r.checked = (r.value === state.mode));

                  migrateOldItems();

                  saveOriginalStates();

                  if (state.mode === "basic") {
                      applyBasicModeNA();
                  } else {
                      save();
                      render();
                  }

                  alert("Backup importiert ‚úì");
              }catch(e){
                  alert("Import fehlgeschlagen: " + (e && e.message ? e.message : "Unbekannter Fehler"));
              }
          });
          inp.click();
      }

      // ====== EVENT HANDLERS ======
      function toggleExportMenu(force){
          const isOpen = elExportPanel.classList.contains("open");
          const next = (force === undefined) ? !isOpen : !!force;
          elExportPanel.classList.toggle("open", next);
      }

      // ====== INITIALIZATION ======
      document.addEventListener("click", (e) => {
          if (!document.getElementById("exportMenu").contains(e.target)) toggleExportMenu(false);
      });

      // Help modal
      document.getElementById("helpBtn").addEventListener("click", () => elHelpModal.style.display = "flex");
      document.getElementById("closeHelpBtn").addEventListener("click", () => elHelpModal.style.display = "none");
      elHelpModal.addEventListener("click", (e) => { if (e.target === elHelpModal) elHelpModal.style.display = "none"; });

      // Datenschutz modal
      document.getElementById("closeDatenschutzBtn").addEventListener("click", hideDatenschutzModal);
      elDatenschutzModal.addEventListener("click", (e) => { 
          if (e.target === elDatenschutzModal) hideDatenschutzModal(); 
      });

      // Compatibilidad modal
      document.getElementById("compatBtn").addEventListener("click", showCompatModal);
      document.getElementById("closeCompatBtn").addEventListener("click", hideCompatModal);
      elCompatModal.addEventListener("click", (e) => { 
          if (e.target === elCompatModal) hideCompatModal(); 
      });
      document.getElementById("downloadPortableBtn").addEventListener("click", downloadPortableVersion);
      document.getElementById("closeAlertBtn").addEventListener("click", hideCompatAlert);
      document.getElementById("showCompatBtn").addEventListener("click", () => {
          hideCompatAlert();
          showCompatModal();
      });

      // Setup events
      elAnlage.addEventListener("change", populateTunnelSelect);
      elTunnel.addEventListener("change", setSetupState);

      elStart.addEventListener("click", () => {
          const a = elAnlage.value;
          const t = askManualTunnelIfNeeded() || elTunnel.value;
          if (!a || !t) return;

          state.anlage = a;
          state.tunnel = t;

          elSetupCard.style.display = "none";
          elAppCard.style.display = "";
          load();
          render();

          state.name = `${state.tunnel} - LCM `;
            elListName.value = state.name;
            save();

          elNewGroupTitle.focus();
      });

      // App events
      document.getElementById("addGroupBtn").addEventListener("click", () => {
          addGroup(elNewGroupTitle.value);
          elNewGroupTitle.value = "";
          elNewGroupTitle.focus();
      });

      elNewGroupTitle.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
              addGroup(elNewGroupTitle.value);
              elNewGroupTitle.value = "";
          }
      });

      elListName.addEventListener("input", () => { state.name = elListName.value; save(); });

      elBasicMode.addEventListener("change", handleModeChange);
      elDetailedMode.addEventListener("change", handleModeChange);

      document.getElementById("setAllOkBtn").addEventListener("click", setAllOk);
      document.getElementById("resetBtn").addEventListener("click", resetAll);
      document.getElementById("collapseAllBtn").addEventListener("click", () => setAllCollapsed(true));
      document.getElementById("expandAllBtn").addEventListener("click", () => setAllCollapsed(false));
      document.getElementById("loadTemplateBtn").addEventListener("click", loadTemplate);

      elExportBtn.addEventListener("click", () => toggleExportMenu());
      document.getElementById("exportPdfBtn").addEventListener("click", () => { toggleExportMenu(false); exportPdf(); });
      document.getElementById("exportCsvBtn").addEventListener("click", () => { toggleExportMenu(false); exportCsv(); });
      elExportWordBtn.addEventListener("click", () => { toggleExportMenu(false); exportWordDoc(); });
      elExportExcelBtn.addEventListener("click", () => { toggleExportMenu(false); exportExcel(); });
      document.getElementById("exportJsonBtn").addEventListener("click", () => { toggleExportMenu(false); exportJson(); });
      document.getElementById("importJsonBtn").addEventListener("click", () => { toggleExportMenu(false); importJson(); });

      // Manejadores para el modal de informaci√≥n de sub-check
      document.getElementById('closeSubcheckInfoBtn').addEventListener('click', hideSubcheckInfo);
      document.getElementById('subcheckInfoModal').addEventListener('click', (e) => {
          if (e.target === document.getElementById('subcheckInfoModal')) {
              hideSubcheckInfo();
          }
      });

      // Cerrar modales con Escape key
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              if (document.getElementById('subcheckInfoModal').classList.contains('open')) {
                  hideSubcheckInfo();
              }
              if (elDatenschutzModal.style.display === 'flex') {
                  hideDatenschutzModal();
              }
              if (elHelpModal.style.display === 'flex') {
                  elHelpModal.style.display = 'none';
              }
              if (elCompatModal.style.display === 'flex') {
                  hideCompatModal();
              }
              if (elCompatAlert.style.display === 'block') {
                  hideCompatAlert();
              }
          }
      });

      // Initialize
      populateTunnelSelect();
      setSetupState();
      updateSidebarStats();
      initCompatibilityCheck();
  </script>

</body></html>
